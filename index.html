<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spy Master - Ultimate</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg: #0f172a;
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --accent: #f43f5e;
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --card-front-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --gold: #f59e0b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Vazirmatn', sans-serif; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; /* Adapts to mobile browsers */
            background-color: var(--bg);
            overflow: hidden; color: var(--text);
            display: flex; align-items: center; justify-content: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(244, 63, 94, 0.15) 0%, transparent 20%);
        }

        /* --- ANIMATED BACKGROUND --- */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.5; }
        .particle { position: absolute; border-radius: 50%; background: white; opacity: 0.3; animation: float infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100px) scale(1); opacity: 0; } }

        /* --- APP CONTAINER --- */
        .app-wrapper {
            width: 100%; max-width: 480px; height: 100%; 
            position: relative; z-index: 10;
            display: flex; flex-direction: column;
        }

        /* --- VIEWS CONTROLLER --- */
        .view {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 5; }
        
        .scroll-content { width: 100%; overflow-y: auto; flex: 1; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
        .scroll-content::-webkit-scrollbar { width: 0px; }

        /* --- UI ELEMENTS --- */
        h1 { margin: 0 0 5px 0; font-size: 1.8rem; font-weight: 900; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; color: transparent; }
        h2 { font-size: 1.4rem; margin: 10px 0; color: #fff; }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; font-weight: 400; }
        
        /* --- TOP BAR --- */
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 40px; }
        .icon-btn { background: var(--glass); border: 1px solid var(--glass-border); color: #fff; width: 40px; height: 40px; border-radius: 12px; display: grid; place-items: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: var(--primary); }

        /* --- INPUTS & CHIPS --- */
        .input-box { width: 100%; position: relative; margin-bottom: 20px; display: flex; gap: 8px; }
        .main-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 12px; color: white; font-size: 1rem; text-align: right; }
        .main-input:focus { border-color: var(--primary); }
        .add-btn { width: 50px; background: var(--primary); border: none; border-radius: 16px; color: white; font-size: 1.2rem; cursor: pointer; }
        
        /* Names Grid */
        .tags-container { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .tag { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tag i { opacity: 0.5; cursor: pointer; padding: 4px; }
        
        /* Topic Selector */
        .section-title { width: 100%; text-align: right; font-size: 0.9rem; color: var(--text-muted); margin: 10px 0; font-weight: 700; }
        .topics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 10px; }
        .topic-card {
            background: var(--glass); border: 1px solid var(--glass-border); padding: 12px; border-radius: 16px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .topic-card.selected { background: rgba(99, 102, 241, 0.2); border-color: var(--primary); box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.2); }
        .topic-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 5px; right: 8px; font-size: 0.8rem; color: var(--primary); }
        .topic-name { font-size: 0.9rem; font-weight: 500; }

        /* Custom Input Area */
        #custom-words-container { 
            width: 100%; margin-bottom: 20px; display: none; animation: slideDown 0.3s forwards; 
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 16px; border: 1px dashed var(--glass-border);
        }
        #custom-words-input {
            width: 100%; min-height: 70px; background: transparent; color: white; border: none; 
            resize: vertical; font-size: 0.9rem; line-height: 1.5; outline: none;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Settings */
        .control-row { display: flex; justify-content: space-between; width: 100%; align-items: center; background: var(--glass); padding: 12px 15px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 10px; }
        .control-label { display: flex; flex-direction: column; text-align: right; }
        .stepper { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 12px; }
        .step-btn { color: var(--text); background: none; border: none; font-size: 1.1rem; width: 30px; cursor: pointer; }
        .step-val { font-weight: 900; width: 20px; text-align: center; }

        /* MAIN ACTION BUTTON */
        .primary-btn {
            width: 100%; max-width: 400px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 16px; border-radius: 20px;
            font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.5);
            cursor: pointer; margin-top: 5px; z-index: 100;
            position: relative; overflow: hidden; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .primary-btn:active { transform: scale(0.98); }
        
        /* --- GAME CARD 3D (RESPONSIVE) --- */
        .card-wrapper { 
            perspective: 1500px; 
            width: 100%; 
            max-width: 340px; 
            /* Responsive Height */
            height: 55vh; 
            min-height: 350px; 
            max-height: 550px; 
            margin: 20px 0; 
        }
        .game-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; }
        .game-card.flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 24px; border: 2px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); text-align: center;
            background-size: cover; background-position: center;
        }
        
        .face-front { background: var(--card-front-grad); z-index: 2; }
        .fingerprint { font-size: 5rem; color: rgba(255,255,255,0.1); margin-bottom: 20px; animation: pulse 2s infinite; }
        .tap-text { color: rgba(255,255,255,0.6); font-size: 1rem; letter-spacing: 2px; text-transform: uppercase; }
        
        .face-back { transform: rotateY(180deg); background: white; color: #1e293b; padding: 20px; }
        .role-badge { background: #1e293b; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .secret-word { font-size: 2.5rem; font-weight: 900; color: #1e293b; line-height: 1.2; margin: 15px 0; word-break: break-word; }
        
        /* SPY MODE STYLES */
        .face-back.spy-mode { background: #111; color: #fff; border: 3px solid var(--accent); }
        .face-back.spy-mode .role-badge { background: var(--accent); color: #fff; }
        .face-back.spy-mode .secret-word { color: var(--accent); font-size: 3.5rem; text-shadow: 0 0 20px rgba(244, 63, 94, 0.4); margin: 30px 0; }

        @keyframes pulse { 0%,100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.1); opacity: 0.5; } }

        /* --- TIMER --- */
        .timer-ring {
            position: relative; width: 220px; height: 220px; border-radius: 50%;
            display: grid; place-items: center; margin: 30px 0;
            background: conic-gradient(var(--primary) var(--progress, 0%), rgba(255,255,255,0.1) 0);
            transition: background 0.1s linear;
        }
        .timer-ring::before { content:''; position: absolute; inset: 10px; border-radius: 50%; background: var(--bg); }
        .time-text { position: relative; font-size: 3.5rem; font-weight: 900; font-variant-numeric: tabular-nums; }
        
        /* --- STARTER INDICATOR MODAL --- */
        .starter-box {
            background: linear-gradient(135deg, #1e293b, #0f172a); padding: 30px; border-radius: 24px; border: 1px solid var(--glass-border);
            text-align: center; margin: auto; box-shadow: 0 30px 80px rgba(0,0,0,0.7); transform: scale(0.9); animation: bounceIn 0.5s forwards; width: 90%;
        }
        .starter-avatar { width: 70px; height: 70px; background: var(--gold); border-radius: 50%; margin: 0 auto 15px; display: grid; place-items: center; font-size: 2rem; color: #000; }
        @keyframes bounceIn { 0% { opacity:0; transform: scale(0.8); } 60% { transform: scale(1.05); } 100% { opacity:1; transform: scale(1); } }

        /* --- HELP MODAL --- */
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 50; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { width: 85%; background: #1e293b; padding: 25px; border-radius: 24px; max-height: 80%; overflow-y: auto; border: 1px solid var(--glass-border); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; }
        .rule-item { display: flex; gap: 12px; margin-bottom: 15px; align-items: center; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .rule-icon { width: 35px; height: 35px; background: rgba(255,255,255,0.1); border-radius: 8px; display: grid; place-items: center; color: var(--primary); flex-shrink: 0; }

        /* --- RESULTS & VOTING --- */
        .results-card { background: rgba(255,255,255,0.05); width: 100%; border-radius: 16px; padding: 15px; margin: 20px 0; }
        .spy-reveal { display: flex; align-items: center; justify-content: space-between; background: rgba(244, 63, 94, 0.2); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid rgba(244, 63, 94, 0.5); }
        .result-phase-container { width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* Voting Specifics */
        .status-box { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; text-align: center; margin-bottom: 20px; font-weight: bold; min-height: 54px; border: 1px solid var(--glass-border); }
        .status-box.success { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: var(--success); }
        .status-box.error { background: rgba(244, 63, 94, 0.2); color: var(--accent); border-color: var(--accent); }
        
        .suspect-card {
            background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 16px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .suspect-card:active { transform: scale(0.95); }
        .suspect-card i { font-size: 1.5rem; margin-bottom: 5px; color: var(--text-muted); }
        .suspect-card.eliminated { opacity: 0.3; pointer-events: none; filter: grayscale(1); transform: scale(0.9); }
        .suspect-card.caught { background: var(--accent); border-color: var(--accent); pointer-events: none; }
        .suspect-card.caught i, .suspect-card.caught div { color: white; }

        /* Winner Header */
        .winner-header { text-align: center; margin-top: 20px; }
        .winner-header i { font-size: 3rem; margin-bottom: 10px; }
        .winner-citizens i { color: var(--success); }
        .winner-citizens h1 { background: none; color: var(--success); -webkit-background-clip: unset; }
        .winner-spies i { color: var(--accent); }
        .winner-spies h1 { background: none; color: var(--accent); -webkit-background-clip: unset; }

        /* --- FOOTER (FIXED) --- */
        .footer { width: 100%; text-align: center; padding: 15px 0 5px 0; font-size: 0.75rem; color: rgba(255,255,255,0.4); letter-spacing: 1px; text-transform: uppercase; }
        .footer b { color: var(--primary); font-weight: 900; }
        
        /* Small Screen Adjustments */
        @media (max-height: 600px) {
            h1 { font-size: 1.5rem; }
            .game-card { height: 60vh; }
            .timer-ring { width: 180px; height: 180px; }
            .time-text { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <!-- Particles BG -->
    <div class="particles" id="particles"></div>

    <!-- App Container -->
    <div class="app-wrapper">

        <!-- VIEW 1: SETUP -->
        <div id="view-setup" class="view active">
            <div class="top-bar">
                <div class="icon-btn" onclick="toggleSound()" id="btn-sound"><i class="fas fa-volume-up"></i></div>
                <div class="icon-btn" onclick="toggleHelp()"><i class="fas fa-question"></i></div>
            </div>

            <div class="scroll-content">
                <h1>یاری سیخوڕەکە</h1>
                <p class="subtitle">کاتی دۆزینەوەی نهێنیەکانە...</p>

                <!-- Topics -->
                <div class="section-title">بابەت هەڵبژێرە (زیاتر لە یەک دانە ئاساییە):</div>
                <div class="topics-grid" id="topics-container"></div>
                
                <!-- Custom Input (Hidden by default) -->
                <div id="custom-words-container">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: bold;">وشە تایبەتەکانت بنووسە:</div>
                    <textarea id="custom-words-input" placeholder="نموونە: تۆپی پێ، باڵە، مەلەوانی... &#10;یان بە ENTER جیایان بکەوە"></textarea>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4); text-align: left; margin-top:5px;">بە کۆما یان دێڕ جیایان بکەرەوە</div>
                </div>

                <!-- Inputs -->
                <div class="section-title">لیستی یاریزانان:</div>
                <div class="input-box">
                    <input type="text" id="player-input" class="main-input" placeholder="ناوی یاریزان..." autocomplete="off">
                    <button class="add-btn" onclick="addPlayer()"><i class="fas fa-plus"></i></button>
                </div>
                <div id="players-container" class="tags-container"></div>
                
                <!-- Game Controls -->
                <div class="section-title">ڕێکخستنەکان:</div>
                <div class="control-row">
                    <div class="control-label"><span>ژمارەی سیخوڕ</span><small>پێشنیارکراو: ١</small></div>
                    <div class="stepper">
                        <button class="step-btn" onclick="adjVal('spy-count', -1)">-</button>
                        <span class="step-val" id="spy-count">1</span>
                        <button class="step-btn" onclick="adjVal('spy-count', 1)">+</button>
                    </div>
                </div>

                <div class="control-row">
                    <div class="control-label"><span>کات (خولەک)</span><small>ماوەی گفتوگۆ</small></div>
                    <div class="stepper">
                        <button class="step-btn" onclick="adjVal('game-time', -1)">-</button>
                        <span class="step-val" id="game-time">5</span>
                        <button class="step-btn" onclick="adjVal('game-time', 1)">+</button>
                    </div>
                </div>
            </div>

            <button class="primary-btn" id="start-btn" onclick="initGame()">
                دەستپێکردن <i class="fas fa-arrow-left"></i>
            </button>
            <div class="footer">Made by <a href="https://instagram.com/baxnasi7" target="_blank"> <b>Bawan</b> </a></div>
        </div>

        <!-- VIEW 2: CARDS (Role Reveal) - NO EXIT BUTTON -->
        <div id="view-cards" class="view">
            <div class="top-bar" style="justify-content: center;">
                <h2 style="margin:0; font-size: 1rem; color:var(--text-muted);">ڕۆڵەکان</h2>
            </div>

            <div class="scroll-content" style="justify-content: center;">
                <div style="text-align:center; margin-bottom: 20px;">
                    <div id="current-player-name" style="font-size: 1.4rem; font-weight: bold; margin-bottom: 5px;">Yarizan</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">مۆبایلەکە بدە دەست ئەم کەسە</div>
                </div>

                <div class="card-wrapper">
                    <div class="game-card" id="the-card" onclick="flipCard()">
                        <!-- Front -->
                        <div class="card-face face-front">
                            <i class="fas fa-fingerprint fingerprint"></i>
                            <div class="tap-text">کلیـک بـکە</div>
                        </div>
                        <!-- Back -->
                        <div class="card-face face-back" id="card-back">
                            <div class="role-badge" id="card-role">...</div>
                            <div class="secret-word" id="card-word">...</div>
                            <p id="card-desc" style="color:inherit; opacity: 0.7; font-size:0.9rem; margin-top: 10px; padding: 0 10px;">...</p>
                            <div style="position:absolute; bottom:20px; opacity:0.4; font-size: 0.75rem;">دووبارە کلیک بکە بۆ شاردنەوە</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: STARTER INDICATOR -->
        <div id="view-starter" class="view" style="justify-content: center;">
             <div class="starter-box">
                 <p style="color: var(--text-muted); margin-bottom: 15px;">پسیاری یەکەم دەکات:</p>
                 <div class="starter-avatar"><i class="fas fa-crown"></i></div>
                 <h2 id="starter-name-display" style="font-size: 2rem; color: #fff; margin: 0;">...</h2>
                 <br>
                 <button class="primary-btn" style="padding: 12px 30px;" onclick="startTimerView()">باشە</button>
             </div>
        </div>

        <!-- VIEW 4: TIMER -->
        <div id="view-timer" class="view">
             <div class="top-bar"><h2 style="margin:0;">کات ماوە</h2></div>
             <div class="scroll-content" style="justify-content: center;">
                <div class="timer-ring" id="timer-ring">
                    <div class="time-text" id="timer-val">00:00</div>
                </div>
                <p class="subtitle" style="text-align: center;">پرسیار لە یەکتری بکەن بەبێ ئەوەی نهێنییەکە ئاشکرا بکەن!</p>
                <button class="icon-btn" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.1); margin-bottom: 30px;" onclick="togglePause()">
                    <i class="fas fa-pause" id="pause-icon"></i>
                </button>
             </div>
             <button class="primary-btn" style="background: var(--accent);" onclick="endGame()">
                کۆتایی هێنان بە کات <i class="fas fa-gavel"></i>
            </button>
        </div>

        <!-- VIEW 5: RESULTS & VOTING -->
        <div id="view-results" class="view">
            <div class="scroll-content" style="align-items: stretch; justify-content: start;">
                <!-- Voting Phase -->
                <div id="phase-voting" class="result-phase-container">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <h2 style="font-size: 1.5rem;">سیخوڕەکە کێیە؟</h2>
                        <p class="subtitle">لەسەر ناوی گومانلێکراو کلیک بکە</p>
                    </div>
                    <div id="voting-status" class="status-box">تکایە گومانلێکراو هەڵبژێرە</div>
                    <div id="suspects-grid" class="topics-grid"></div>
                    <button class="primary-btn" style="background: rgba(255,255,255,0.1); margin-top: 20px; font-size: 0.9rem;" onclick="revealEverything('neutral')">
                         کۆتایی / هەموویان ئاشکرا بکە
                    </button>
                </div>
                <!-- Final Results -->
                <div id="phase-post-reveal" class="result-phase-container" style="display: none;">
                    <div id="winner-display" class="winner-header"></div>
                    <div class="results-card">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">وشەکە ئەمە بوو:</div>
                        <div id="result-word" style="font-size: 1.8rem; font-weight: 900; color: var(--primary); text-align: center; margin-bottom: 20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px;">-</div>
                        <div style="font-size: 0.9rem; color: var(--accent); font-weight: bold;">سیخوڕەکان:</div>
                        <div id="spies-list"></div>
                    </div>
                    <button class="primary-btn" onclick="goToSetup()">یاری نوێ <i class="fas fa-redo"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="toggleHelp()"><i class="fas fa-times"></i></button>
            <h2>چۆنیەتی یاریکردن</h2>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-user"></i></div>
                <div><b>هاوڵاتی</b><div style="font-size: 0.8rem; color: #aaa;">وشەکەی دەزانێت. دەبێت پرسیار بکات بۆ دۆزینەوەی سیخوڕەکە.</div></div>
            </div>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-user-secret"></i></div>
                <div><b>سیخوڕ</b><div style="font-size: 0.8rem; color: #aaa;">وشەکە نازانێت. دەبێت خۆی وەک هاوڵاتی دەربخات.</div></div>
            </div>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-trophy"></i></div>
                <div><b>بردنەوە</b><div style="font-size: 0.8rem; color: #aaa;">هاوڵاتیان دەیبەنەوە ئەگەر سیخوڕ بدۆزنەوە. سیخوڕ دەیباتەوە ئەگەر بمێنێتەوە یان وشەکە بزانێت.</div></div>
            </div>
            <div class="rule-item">
                <div><b>Feedback</b><div style="font-size: 0.8rem; color: #aaa;">بۆ هەر ڕەخنەو تێبینیەک پەیوەندیم پێوە بکەن ❤️</div><br>
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <a href="https://instagram.com/baxnasi7"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Instagram_logo_2016.svg/120px-Instagram_logo_2016.svg.png" width="30"/></a>
                        <a href="https://facebook.com/bawannasih"><img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" width="30"/></a>
                        <a href="https://t.me/paperui"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="30"/></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: WORD CATEGORIES (EXPANDED) ---
        const CATEGORIES = {
            "places": { 
                label: "شوێن", 
                icon: "fa-map-marker-alt", 
                words: [
                    "قوتابخانە", "نەخۆشخانە", "فڕۆکەخانە", "بازاڕ", "مزگەوت", "کتێبخانە", "سینەما", "پارک", 
                    "بەندیخانە", "ڕێستۆرانت", "هۆتێل", "دەریا", "دارستان", "شار", "گوند", "مۆزەخانە", "یاریگا", 
                    "قاوەخانە", "شاری یاری", "هۆڵی وەرزش", "زانکۆ", "بانک", "وێستگەی شەمەندەفەر", "شەقام", 
                    "ئەشکەوت", "بیابان", "کەنار دەریا", "باخچەی ئاژەڵان", "نانەواخانە", "سەرتاشخانە", "مەزرا",
                    "کۆشک", "پرد", "تونێل", "بنزینخانە", "بنکەی پۆلیس", "بنکەی ئاگرکوژێنەوە", "مەلەوانگە",
                    "چێشتخانە", "هۆڵی ئاهەنگ", "گۆڕەپان", "شاژەن", "کارگە", "تاقیگە", "خەستەخانە", "بەشە ناوخۆیی",
                    "مۆڵ", "سوپەرمارکێت", "باخچەی ساوایان", "هەولێر", "سلێمانی", "دهۆک", "قەڵا", "سەیرانگا", "چیا"
                ] 
            },
            "objects": { 
                label: "کەرەستە", 
                icon: "fa-cube", 
                words: [
                    "مۆبایل", "لاپتۆپ", "کورسی", "قەڵەم", "ئاوێنە", "سەعات", "کتێب", "چەقۆ", "پەرداخ", 
                    "تەلەفزیۆن", "کامێرا", "کلیل", "چەکوش", "چرای سەرمێز", "پاتری", "سابون", "خاولی", 
                    "شەوت", "دەرمان", "پاکەت", "فڵچەی ددان", "شامپۆ", "سەرین", "بەتانی", "شانە", 
                    "مەقەست", "لکێنەر", "جزدان", "پێڵاو", "گۆرەوی", "کڵاو", "چەتر", "گوڵ", "ئەڵقە", 
                    "عەینەک", "گوێچکەگر", "مایکرۆفۆن", "گیتار", "پیانۆ", "تۆپ", "مێز", "دەرگا", "پەنجەرە",
                    "سەیارە", "پاسکیل", "کوپ", "قاپ", "کەوچک", "چەتال", "جلشۆر", "فرن", "سەلاجە", "خەڵوز",
                    "گوڵدان", "تەپڵەک", "کۆمپیوتەر", "تابلێت", "پێنوسی جاف", "رۆژمێر", "نەخشە", "ئاڵا"
                ] 
            },
            "food": { 
                label: "خواردن", 
                icon: "fa-hamburger", 
                words: [
                    "پیتزا", "کەباب", "مەنسەف", "یاپراخ", "برنج", "سێو", "هەنار", "قاوە", "شەربەت", 
                    "نان", "پەنیر", "ماست", "کێکی لەدایکبوون", "بەستەنی", "شوکۆلاتە", "ماکارۆنی", 
                    "شوتی", "سپێناخ", "ترێ", "هەمبەرگر", "پەتاتە", "شۆربا", "زەڵاتە", "گۆشت", "ماسی", 
                    "سوشی", "جپس", "چای", "شیر", "ئاو", "هێلکە", "هەنگوین", "مرەبا", "قەیسی", "فراولە", 
                    "مۆز", "لیمۆ", "خەیار", "تەماتە", "بیبەر", "کوولەکە", "دۆڵمە", "بریانی", "شفتە",
                    "کفتە", "نیسک", "لۆبیا", "فاسۆلیا", "سەروپێ", "پاقلە", "شێلم", "چەرەزات", "کەرە",
                    "هەنجیر", "کاڵەک", "قۆخ", "خوێ", "شەکر", "زەیتوون", "خورما", "کولێرە"
                ] 
            },
            "animals": { 
                label: "گیانلەبەر", 
                icon: "fa-cat", 
                words: [
                    "شێر", "پشیلە", "سەگ", "گورگ", "هەڵۆ", "کۆتر", "مار", "بزن", "مانگا", "ماسی", 
                    "توتی", "مێروولە", "پەپوولە", "بەراز", "کەرکەدەن", "فیل", "مامز", "کیسەڵ", "زەڕافە", 
                    "مەیمون", "کەنگەر", "پاندە", "ورچ", "پڵنگ", "کەروێشک", "مشک", "مریشک", "قاز", 
                    "ئەسپ", "کەر", "حوشتر", "بوق", "قرژاڵ", "پەنگوین", "دۆلفین", "نەهەنگ", "کووندەپەپوو",
                    "رێوی", "سمۆرە", "داڵ", "مەل", "کەڵەشێر", "قەل", "زەنگەسوورە", "مێش", "هەنگ",
                    "پشک", "مارمێلکە", "قرش", "ئەسپۆکە", "کرم", "تەیر", "باڵندە", "فلامینگۆ", "نەورس"
                ] 
            },
            "jobs": { 
                label: "پیشەکان", 
                icon: "fa-briefcase", 
                words: [
                    "پزیشک", "ئەندازیار", "مامۆستا", "فڕۆکەوان", "پۆلیس", "تەباخ", "نیگارکێش", "وەرزشەوان", 
                    "نووسەر", "گۆرانیبێژ", "ئارایشگەر", "شۆفێر", "پارێزەر", "وەستا", "جوتیار", "ئەکتەر", 
                    "سەرباز", "ئاگرکوژێنەوە", "پەرستار", "دکتۆری ددان", "فیتەر", "کارەباچی", "شوان", 
                    "ماسیگر", "پۆستەچی", "وێنەگر", "خەیات", "دارتاش", "کەشتیوان", "دادوەر", "ڕۆژنامەنووس",
                    "دەرمانساز", "ژمێریار", "وەرگێڕ", "بەڕێوبەر", "کرێکار", "ناوەڕاست", "گۆڵچی", "سەرۆک",
                    "وەزیر", "پەرلەمانتار", "شاعیر", "مۆسیقاژەن", "تەلارساز", "کاسب", "دوکاندار", "فیتەر"
                ] 
            },
            "custom": { label: "تایبەت", icon: "fa-pen-fancy", words: [] }
        };

        // --- STATE MANAGEMENT ---
        const state = {
            players: [], numSpies: 1, gameTime: 5, selectedCats: new Set([]), isSoundOn: true,
            currentWord: '', assignments: [], activeSpies: 0, activeCitizens: 0, cardIndex: 0, timerRunning: false, timeLeft: 0, timerInt: null
        };

        // --- DOM HELPERS ---
        const $ = (id) => document.getElementById(id);
        const transitionTo = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            $(viewId).classList.add('active');
            playSfx('swish');
        };

        // --- SETUP SCREEN LOGIC ---
        const setupGrid = () => {
            const grid = $('topics-container');
            grid.innerHTML = '';
            for (const [key, cat] of Object.entries(CATEGORIES)) {
                const div = document.createElement('div');
                div.className = `topic-card`;
                div.innerHTML = `<i class="fas ${cat.icon}"></i><div class="topic-name">${cat.label}</div>`;
                div.onclick = () => toggleTopic(key, div);
                grid.appendChild(div);
            }
        };
        setupGrid();

        function toggleTopic(key, el) {
            if (state.selectedCats.has(key)) {
                state.selectedCats.delete(key);
                el.classList.remove('selected');
            } else {
                state.selectedCats.add(key);
                el.classList.add('selected');
            }
            if (key === 'custom') {
                const container = $('custom-words-container');
                if (state.selectedCats.has('custom')) {
                    container.style.display = 'block';
                    setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                } else {
                    container.style.display = 'none';
                }
            }
            playSfx('click');
            if(navigator.vibrate) navigator.vibrate(10);
        }

        function addPlayer() {
            const input = $('player-input');
            const name = input.value.trim();
            if(name && !state.players.includes(name)) {
                state.players.push(name);
                renderTags();
                input.value = '';
                playSfx('pop');
            } else if(state.players.includes(name)) {
                input.classList.add('error-shake');
                setTimeout(()=>input.classList.remove('error-shake'), 500);
            }
        }
        $('player-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') addPlayer(); });

        function renderTags() {
            const c = $('players-container');
            c.innerHTML = state.players.map((p,i) => 
                `<div class="tag">${p} <i class="fas fa-times" onclick="removePlayer(${i})"></i></div>`
            ).join('');
            const spyLimit = Math.max(1, Math.floor(state.players.length / 2));
            if(parseInt($('spy-count').innerText) > spyLimit) $('spy-count').innerText = spyLimit;
        }

        function removePlayer(i) {
            state.players.splice(i, 1);
            renderTags();
            playSfx('click');
        }

        function adjVal(id, amount) {
            const el = $(id);
            let val = parseInt(el.innerText) + amount;
            if(id === 'spy-count') {
                const max = Math.max(1, Math.floor(state.players.length / 2)) || 1;
                if(val < 1) val = 1;
                if(val > max && state.players.length > 2) val = max; 
                state.numSpies = val;
            } else {
                if(val < 1) val = 1; if(val > 60) val = 60;
                state.gameTime = val;
            }
            el.innerText = val;
            playSfx('click');
        }

        // --- GAME INITIALIZATION ---
        function initGame() {
            if (state.players.length < 3) { alert("لانی کەم دەبێت ٣ یاریزان هەبن"); return; }
            if (state.selectedCats.size === 0) { alert("تکایە لانی کەم بابەتێک هەڵبژێرە"); return; }
            if(audioCtx.state === 'suspended') audioCtx.resume();

            state.numSpies = parseInt($('spy-count').innerText);
            let pool = [];
            state.selectedCats.forEach(catKey => {
                if(catKey === 'custom') {
                    const rawText = $('custom-words-input').value;
                    const customWords = rawText.split(/[\n,،]+/).map(w => w.trim()).filter(w => w.length > 0);
                    if(customWords.length > 0) pool = pool.concat(customWords);
                } else if(CATEGORIES[catKey]) {
                    pool = pool.concat(CATEGORIES[catKey].words);
                }
            });

            if(pool.length === 0) { alert("هەڵەیەک ڕوویدا لە دۆزینەوەی وشەکان"); return; }
            state.currentWord = pool[Math.floor(Math.random() * pool.length)];

            let roles = Array(state.numSpies).fill('spy').concat(Array(state.players.length - state.numSpies).fill('citizen'));
            roles.sort(() => Math.random() - 0.5);
            let shuffledPlayers = [...state.players].sort(() => Math.random() - 0.5);

            state.assignments = shuffledPlayers.map((p, i) => ({ name: p, role: roles[i], id: i }));
            state.cardIndex = 0;
            showCardScreen();
        }

        // --- CARD LOGIC ---
        let isFlipped = false;
        function showCardScreen() { transitionTo('view-cards'); updateCardView(); }
        function updateCardView() {
            const card = $('the-card');
            card.classList.remove('flipped');
            isFlipped = false;
            setTimeout(() => {
                const player = state.assignments[state.cardIndex];
                $('current-player-name').innerText = player.name;
                $('current-player-name').style.color = "white";
                
                const isSpy = player.role === 'spy';
                if (isSpy) {
                    $('card-back').className = `card-face face-back spy-mode`;
                    $('card-role').innerText = "نـهێـنـی";
                    $('card-word').innerText = "تۆ سیخوڕیت!";
                    $('card-desc').innerText = "خۆت وەکو هاوڵاتی دەربخە. هەوڵبدە لە قسەی ئەوانی ترەوە وشەکە بزانیت.";
                } else {
                    $('card-back').className = `card-face face-back`;
                    $('card-role').innerText = "تۆ هاوڵاتییت";
                    $('card-word').innerText = state.currentWord;
                    $('card-desc').innerText = "سیخوڕەکە لە ناوتاندایە. وریا بە لە کاتی پرسیارکردن.";
                }
            }, 200);
        }

        function flipCard() {
            const card = $('the-card');
            if(!isFlipped) {
                playSfx('flip'); card.classList.add('flipped'); isFlipped = true;
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
                playSfx('flip'); card.classList.remove('flipped'); isFlipped = false;
                setTimeout(() => {
                    state.cardIndex++;
                    if(state.cardIndex >= state.assignments.length) determineStarter();
                    else updateCardView();
                }, 600);
            }
        }

        function determineStarter() {
            const citizens = state.assignments.filter(p => p.role === 'citizen');
            const pool = citizens.length > 0 ? citizens : state.assignments;
            const randomStarter = pool[Math.floor(Math.random() * pool.length)];
            $('starter-name-display').innerText = randomStarter.name;
            transitionTo('view-starter');
            playSfx('victory');
        }

        // --- TIMER ---
        function startTimerView() { transitionTo('view-timer'); startTimer(state.gameTime * 60); }
        function startTimer(seconds) {
            state.timeLeft = seconds;
            const totalTime = seconds;
            updateTimerDisplay(totalTime);
            clearInterval(state.timerInt);
            state.timerRunning = true;
            $('pause-icon').className = "fas fa-pause";
            state.timerInt = setInterval(() => {
                if(!state.timerRunning) return;
                state.timeLeft--;
                updateTimerDisplay(totalTime);
                if(state.timeLeft <= 0) { clearInterval(state.timerInt); endGame(); }
            }, 1000);
        }
        function updateTimerDisplay(total) {
            const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timeLeft % 60).toString().padStart(2, '0');
            $('timer-val').innerText = `${m}:${s}`;
            const pct = ((total - state.timeLeft) / total) * 100;
            $('timer-ring').style.setProperty('--progress', `${pct}%`);
            if(state.timeLeft <= 10) {
                $('timer-ring').style.background = `conic-gradient(#f43f5e ${pct}%, rgba(255,255,255,0.1) 0)`;
                $('timer-val').style.color = "#f43f5e";
                if(state.timeLeft > 0) playSfx('tick');
            }
        }
        function togglePause() {
            state.timerRunning = !state.timerRunning;
            $('pause-icon').className = state.timerRunning ? "fas fa-pause" : "fas fa-play";
            playSfx('click');
        }

        function endGame() {
            clearInterval(state.timerInt);
            try { playSfx('alarm'); if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]); } catch(e){}
            initVotingPhase();
            transitionTo('view-results');
        }

        // --- VOTING LOGIC ---
        function initVotingPhase() {
            $('phase-voting').style.display = 'flex';
            $('phase-post-reveal').style.display = 'none';
            $('voting-status').className = 'status-box';
            $('voting-status').innerText = "تکایە گومانلێکراو هەڵبژێرە";
            state.activeSpies = state.numSpies;
            state.activeCitizens = state.players.length - state.numSpies;
            const grid = $('suspects-grid');
            grid.innerHTML = '';
            state.assignments.forEach(player => {
                const btn = document.createElement('div');
                btn.className = 'suspect-card';
                btn.innerHTML = `<i class="fas fa-user"></i><div>${player.name}</div>`;
                btn.onclick = () => checkSuspect(player, btn);
                grid.appendChild(btn);
            });
        }

        function checkSuspect(player, btnElement) {
            const statusBox = $('voting-status');
            if (player.role === 'spy') {
                playSfx('victory'); if(navigator.vibrate) navigator.vibrate(200);
                state.activeSpies--;
                btnElement.classList.add('caught');
                btnElement.innerHTML = `<i class="fas fa-check"></i><div>${player.name}</div>`;
                statusBox.className = 'status-box success';
                statusBox.innerText = `ئافەرین! ${player.name} سیخوڕ بوو!`;
                if (state.activeSpies === 0) setTimeout(() => revealEverything('citizens'), 1000);
            } else {
                playSfx('pop'); if(navigator.vibrate) navigator.vibrate(50);
                state.activeCitizens--;
                btnElement.classList.add('eliminated');
                statusBox.className = 'status-box error';
                statusBox.innerText = `${player.name} بێتاوانە! سیخوڕ نییە.`;
                if (state.activeSpies >= state.activeCitizens) setTimeout(() => revealEverything('spies'), 1000);
            }
        }

        function revealEverything(winner) {
            const winDisplay = $('winner-display');
            winDisplay.innerHTML = '';
            if (winner === 'citizens') {
                winDisplay.className = "winner-header winner-citizens";
                winDisplay.innerHTML = `<i class="fas fa-trophy"></i><h1>هاوڵاتیان بردیانەوە!</h1>`;
                playSfx('victory');
            } else if (winner === 'spies') {
                winDisplay.className = "winner-header winner-spies";
                winDisplay.innerHTML = `<i class="fas fa-user-secret"></i><h1>سیخوڕەکان بردیانەوە!</h1>`;
                playSfx('alarm');
            } else {
                winDisplay.className = "winner-header";
                winDisplay.innerHTML = `<i class="fas fa-flag-checkered"></i><h1>ئەنجامەکان</h1>`;
            }

            $('result-word').innerText = state.currentWord || "Error";
            const spies = state.assignments.filter(a => a.role === 'spy');
            $('spies-list').innerHTML = spies.map(s => 
                `<div class="spy-reveal"><span style="font-weight:bold; color:white">${s.name}</span> <i class="fas fa-user-secret"></i></div>`
            ).join('');

            $('phase-voting').style.display = 'none';
            $('phase-post-reveal').style.display = 'flex';
            $('phase-post-reveal').classList.add('active');
        }

        function goToSetup() { state.timerRunning = false; clearInterval(state.timerInt); transitionTo('view-setup'); }
        function toggleSound() { state.isSoundOn = !state.isSoundOn; $('btn-sound').style.opacity = state.isSoundOn?1:0.5; $('btn-sound').innerHTML=state.isSoundOn?'<i class="fas fa-volume-up"></i>':'<i class="fas fa-volume-mute"></i>'; }
        function toggleHelp() { const m=$('help-modal'); if(m.style.display==='flex'){m.classList.remove('open');setTimeout(()=>m.style.display='none',300)}else{m.style.display='flex';requestAnimationFrame(()=>m.classList.add('open'));} }

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if(!state.isSoundOn) return;
            try { if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(type === 'click') { osc.type='sine'; osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(300,now+0.1); gain.gain.setValueAtTime(0.1,now); gain.gain.linearRampToValueAtTime(0,now+0.1); osc.start(now); osc.stop(now+0.1); }
            else if(type === 'pop') { osc.type='triangle'; osc.frequency.setValueAtTime(600,now); gain.gain.setValueAtTime(0.1,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
            else if(type === 'flip') { osc.type='sine'; osc.frequency.setValueAtTime(200,now); osc.frequency.linearRampToValueAtTime(400,now+0.2); gain.gain.setValueAtTime(0.05,now); gain.gain.linearRampToValueAtTime(0,now+0.2); osc.start(now); osc.stop(now+0.2); }
            else if(type === 'alarm') { osc.type='sawtooth'; osc.frequency.setValueAtTime(440,now); gain.gain.setValueAtTime(0.2,now); gain.gain.linearRampToValueAtTime(0,now+0.5); osc.start(now); osc.stop(now+0.5); }
            else if(type === 'victory') { osc.type='square'; osc.frequency.setValueAtTime(523,now); osc.frequency.setValueAtTime(659,now+0.1); osc.frequency.setValueAtTime(783,now+0.2); gain.gain.setValueAtTime(0.1,now); gain.gain.linearRampToValueAtTime(0,now+0.6); osc.start(now); osc.stop(now+0.6); }
            else if(type === 'swish') { osc.type='sine'; gain.gain.setValueAtTime(0,now); gain.gain.linearRampToValueAtTime(0.1,now+0.1); gain.gain.linearRampToValueAtTime(0,now+0.2); osc.start(now); osc.stop(now+0.2); }
            } catch(e){}
        }
        
        // Particles
        const pC=document.getElementById('particles'); for(let i=0;i<20;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.animationDuration=(Math.random()*10+10)+'s';pC.appendChild(p);}
    </script>
</body>
</html>