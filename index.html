<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spy Game - Ultimate Fixed</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.6);
            --accent: #f43f5e;
            --accent-glow: rgba(244, 63, 94, 0.6);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-front: linear-gradient(135deg, #1e293b, #0f172a);
            --card-back-citizen: linear-gradient(135deg, #e0e7ff, #fff);
            --card-back-spy: linear-gradient(135deg, #ffe4e6, #fff1f2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Vazirmatn', sans-serif; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0; min-height: 100vh;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; color: var(--text-main);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- BACKGROUND SHAPES --- */
        .blobs { position: absolute; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.4;
            animation: floatBlob 10s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        .blob:nth-child(1) { top: -10%; left: -10%; width: 300px; height: 300px; background: var(--primary); }
        .blob:nth-child(2) { bottom: -10%; right: -10%; width: 250px; height: 250px; background: var(--accent); animation-delay: -5s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, -30px) scale(1.1); } }

        /* --- MAIN CONTAINER --- */
        .container {
            width: 90%; max-width: 450px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 30px 25px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            z-index: 10;
            position: relative;
            /* Fix for overlapping: Only visible one takes space */
            display: none; 
            flex-direction: column;
            align-items: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* THE FIX: Only show container if it has 'active' class */
        .container.active { display: flex; animation: fadeIn 0.5s ease-out forwards; }
        
        .container::-webkit-scrollbar { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY --- */
        h1 { margin: 0; font-size: 2rem; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        .subtitle { color: var(--text-muted); margin-top: 5px; font-size: 0.9rem; margin-bottom: 25px; font-weight: 300; }

        /* --- FOOTER --- */
        .footer {
            margin-top: auto; padding-top: 20px; width: 100%;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem; color: rgba(255,255,255,0.4);
            letter-spacing: 1px; text-transform: uppercase;
        }
        .footer b { color: var(--primary); font-weight: 900; }

        /* --- INPUTS --- */
        .input-group { position: relative; margin-bottom: 20px; display: flex; gap: 10px; width: 100%; }
        .main-input {
            width: 100%; padding: 14px 20px;
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border);
            border-radius: 16px; color: white; font-size: 1rem; text-align: right;
            transition: 0.3s;
        }
        .main-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); background: rgba(0,0,0,0.5); }
        .add-btn {
            background: var(--primary); color: white; border: none; border-radius: 16px;
            width: 55px; font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 10px var(--primary-glow);
        }
        .add-btn:active { transform: scale(0.95); }

        /* --- NAMES LIST --- */
        .names-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; min-height: 40px; width: 100%; }
        .name-tag {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            padding: 6px 14px; border-radius: 50px; font-size: 0.85rem; color: #fff;
            display: flex; align-items: center; gap: 8px;
            animation: popIn 0.3s ease;
        }
        .name-tag i { color: var(--accent); cursor: pointer; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- SETTINGS ROW --- */
        .settings-row { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; }
        .setting-box {
            flex: 1;
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 14px;
            border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center;
        }
        .setting-box label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }
        .setting-box input {
            width: 100%; background: transparent; border: none;
            color: white; font-weight: bold; text-align: center; font-size: 1.2rem;
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            color: white; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 25px -5px var(--primary-glow);
            transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn.secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid var(--glass-border); margin-top: 10px; }
        .btn.outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text-muted); box-shadow: none; margin-top: 10px; }

        /* --- CARD --- */
        .card-container { perspective: 1200px; width: 100%; height: 320px; margin: 20px 0; position: relative; z-index: 20; }
        .card {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card.disabled { pointer-events: none; }
        
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
        }
        .card-front { background: var(--card-front); }
        .scan-anim {
            width: 70px; height: 70px; border: 2px solid rgba(99, 102, 241, 0.5);
            border-radius: 12px; position: relative; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            background: rgba(0,0,0,0.3);
        }
        .scan-anim i { font-size: 2.5rem; color: var(--primary); opacity: 0.8; }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #a5b4fc;
            box-shadow: 0 0 10px #a5b4fc; top: 0;
            animation: scan 2s infinite;
        }
        @keyframes scan { 0%, 100% { top: 0; opacity: 0; } 10%, 90% { opacity: 1; } }

        /* CARD BACK */
        .card-back { background: var(--card-back-citizen); transform: rotateY(180deg); color: #1e293b; }
        .role-title { font-size: 1.2rem; text-transform: uppercase; color: #64748b; font-weight: 700; }
        .secret-word { font-size: 3rem; font-weight: 900; color: #334155; margin: 10px 0; }
        .role-desc { font-size: 0.9rem; color: #64748b; padding: 0 10px; }

        /* SPY MODE */
        .card.spy-active .card-back { background: var(--card-back-spy); border: 2px solid var(--accent); }
        .card.spy-active .card-back .role-title { color: var(--accent); }
        .card.spy-active .card-back .secret-word { font-size: 5rem; animation: shake 3s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 2% { transform: rotate(5deg); } 4% { transform: rotate(-5deg); } }

        /* --- TIMER SCREEN --- */
        .timer-display {
            font-size: 5rem; font-weight: 900; color: white;
            text-shadow: 0 0 30px var(--primary); margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }
        .timer-anim { width: 150px; height: 150px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; margin: 0 auto; animation: spin 2s linear infinite; display: flex; align-items: center; justify-content: center; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- REVEAL SECTION --- */
        .reveal-box {
            background: rgba(244, 63, 94, 0.15); border: 1px solid var(--accent);
            padding: 15px; border-radius: 15px; margin: 20px 0; width: 100%;
        }
        .imposter-tag {
            background: var(--accent); color: white; padding: 5px 12px;
            border-radius: 4px; font-weight: bold; margin: 5px; display: inline-block;
        }

        .badge { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; padding: 5px 15px; border-radius: 50px; font-size: 0.9rem; margin-bottom: 10px; display: inline-block; border: 1px solid rgba(99, 102, 241, 0.3); }
        .error { color: var(--accent); font-weight: bold; margin-bottom: 10px; font-size: 0.85rem; min-height: 20px; }

        /* CONFETTI */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; pointer-events: none; z-index: 100; }
        @keyframes fall { to { opacity: 0; top: 110vh; transform: translateX(100px) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="blobs"><div class="blob"></div><div class="blob"></div></div>

    <!-- 1. SETUP SCREEN -->
    <div id="setup-screen" class="container active">
        <i class="fas fa-mask" style="font-size: 3rem; color: var(--text-main); margin-bottom: 10px;"></i>
        <h1>ÛŒØ§Ø±ÛŒ Ø³ÛŒØ®ÙˆÚ•Û•Ú©Û•</h1>
        <p class="subtitle">Ultimate Edition</p>

        <div class="input-group">
            <input type="text" id="name-input" class="main-input" placeholder="Ù†Ø§ÙˆÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†..." onkeypress="handleEnter(event)" autocomplete="off">
            <button class="add-btn" onclick="addName()"><i class="fas fa-plus"></i></button>
        </div>

        <div id="names-list" class="names-list"></div>

        <div class="settings-row">
            <div class="setting-box">
                <label>Ø³ÛŒØ®ÙˆÚ•</label>
                <input type="number" id="num-spies" value="1" min="1" max="5">
            </div>
            <div class="setting-box">
                <label>Ú©Ø§Øª (Ø®ÙˆÙ„Û•Ú©)</label>
                <input type="number" id="game-timer" value="5" min="1" max="30">
            </div>
        </div>

        <div id="error-msg" class="error"></div>

        <button class="btn" onclick="startGame()">
            Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù† <i class="fas fa-arrow-left"></i>
        </button>

        <div class="footer">Made by <b>Bawan</b></div>
    </div>

    <!-- 2. GAME SCREEN (CARDS) -->
    <div id="game-screen" class="container">
        <div class="badge" id="player-indicator">Unknown</div>
        <h2 style="margin: 0; color: #fff;">Ú•Û†ÚµÛ•Ú©Û•Øª Ø¨Ø¨ÛŒÙ†Û•</h2>
        
        <div class="card-container">
            <div class="card" id="game-card" onclick="handleCardInteraction()">
                <div class="card-face card-front">
                    <div class="scan-anim"><i class="fas fa-fingerprint"></i><div class="scan-line"></div></div>
                    <p style="opacity: 0.7;">Ú©Ù„ÛŒÚ© Ø¨Ú©Û•</p>
                </div>
                <div class="card-face card-back">
                    <div class="role-title" id="role-text">...</div>
                    <div class="secret-word" id="word-text">...</div>
                    <p class="role-desc" id="role-desc">...</p>
                </div>
            </div>
        </div>
        
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 20px;">
            Ø¯ÙˆØ§ÛŒ Ø¨ÛŒÙ†ÛŒÙ†ÛŒ ÙˆØ´Û•Ú©Û•ØŒ Ú©Ù„ÛŒÚ© Ø¨Ú©Û• Ø¨Û† Ø´Ø§Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ
        </p>
        <div class="footer">Made by <b>Bawan</b></div>
    </div>

    <!-- 3. TIMER SCREEN -->
    <div id="timer-screen" class="container">
        <h2 style="color: #fff;">Ú¯ÙØªÙˆÚ¯Û† Ø¨Ú©Û•Ù†!</h2>
        <p class="subtitle">Ø³ÛŒØ®ÙˆÚ•Û•Ú©Û• Ø¨Ø¯Û†Ø²Ù†Û•ÙˆÛ•</p>
        
        <div class="timer-anim">
            <i class="fas fa-hourglass-half" style="font-size: 2rem; color:white;"></i>
        </div>
        
        <div class="timer-display" id="timer-display">00:00</div>

        <button class="btn" onclick="finishGame()">
            ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆÙ†ÛŒ Ú©Ø§Øª <i class="fas fa-stopwatch"></i>
        </button>
        <div class="footer">Made by <b>Bawan</b></div>
    </div>

    <!-- 4. FINISH SCREEN -->
    <div id="end-screen" class="container">
        <i class="fas fa-flag-checkered" style="font-size: 3rem; color: #2ecc71; margin-bottom: 10px;"></i>
        <h1>Ú©Ø§Øª ØªÛ•ÙˆØ§Ùˆ!</h1>
        
        <div class="reveal-box">
            <div style="font-size: 0.9rem; color: #a11; margin-bottom: 5px;">Ø³ÛŒØ®ÙˆÚ•Û•Ú©Ø§Ù†:</div>
            <div id="spies-reveal-list">
                <!-- Spies go here -->
            </div>
        </div>
        
        <button class="btn" onclick="restartSamePlayers()">
            ÛŒØ§Ø±ÛŒ Ù†ÙˆÛ (Ù‡Û•Ù…Ø§Ù† Ù†Ø§Ùˆ) <i class="fas fa-redo"></i>
        </button>

        <button class="btn secondary" onclick="editPlayers()">
            Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ Ù†Ø§ÙˆÛ•Ú©Ø§Ù† <i class="fas fa-user-edit"></i>
        </button>

        <button class="btn outline" onclick="resetGame()">
            Ø³Û•Ø±Û•ØªØ§
        </button>
        
        <div class="footer">Made by <b>Bawan</b></div>
    </div>

    <script>
        // --- WORD LIST ---
        const rawWords = `Ø¦Ø§ÙˆØŒ Ø¦Ø§Ú¯Ø±ØŒ Ø®Ø§Ú©ØŒ Ø¨Ø§ØŒ Ú˜ÛŒØ§Ù†ØŒ Ù…Ø±Û†Ú¤ØŒ Ø¯ÚµØŒ Ú†Ø§ÙˆØŒ Ø¯Û•Ø³ØªØŒ Ø³Û•Ø±ØŒ Ù¾ÛØŒ Ù…Ø§ÚµØŒ Ø´Ø§Ø±ØŒ Ú¯ÙˆÙ†Ø¯ØŒ Ú•ÛÚ¯Ø§ØŒ Ø¦Ø§Ø³Ù…Ø§Ù†ØŒ Ù‡Û•ØªØ§ÙˆØŒ Ù…Ø§Ù†Ú¯ØŒ Ø¦Û•Ø³ØªÛØ±Û•ØŒ Ø´Û•ÙˆØŒ Ú•Û†Ú˜ØŒ Ø¨Û•Ù‡Ø§Ø±ØŒ Ù‡Ø§ÙˆÛŒÙ†ØŒ Ù¾Ø§ÛŒØ²ØŒ Ø²Ø³ØªØ§Ù†ØŒ Ø¨Ø§Ø±Ø§Ù†ØŒ Ø¨Û•ÙØ±ØŒ Ù‡Û•ÙˆØ±ØŒ Ø¦Ø§Ø²Ø§Ø¯ÛŒØŒ Ø®Û†Ø´Û•ÙˆÛŒØ³ØªÛŒØŒ Ú˜Ù†ØŒ Ù¾ÛŒØ§ÙˆØŒ Ù…Ù†Ø¯Ø§ÚµØŒ Ø¨Ø§ÙˆÚ©ØŒ Ø¯Ø§ÛŒÚ©ØŒ Ø¨Ø±Ø§ØŒ Ø®ÙˆØ´Ú©ØŒ Ù‡Ø§ÙˆÚ•ÛØŒ Ø¯Ø±Ø§ÙˆØ³ÛØŒ Ù…Ø§Ù…Û†Ø³ØªØ§ØŒ Ù‚ÙˆØªØ§Ø¨ÛŒØŒ Ú©ØªÛØ¨ØŒ Ù‚Û•ÚµÛ•Ù…ØŒ Ø²Ø§Ù†Ú©Û†ØŒ Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ØŒ Ú©Ø§Ø±ØŒ Ù¾Ø§Ø±Û•ØŒ Ø¨Ø§Ø²Ø§Ú•ØŒ Ù†Ø§Ù†ØŒ Ø¦Ø§Ø´ØŒ Ú¯Û†Ø´ØªØŒ Ø³Û•ÙˆØ²Û•ØŒ Ù…ÛŒÙˆÛ•ØŒ Ø³ÛÙˆØŒ Ù‡Û•Ù†Ø§Ø±ØŒ Ù‡Û•Ù†Ú¯ÙˆÛŒÙ†ØŒ Ø´ÛŒØ±ØŒ Ù¾Û•Ù†ÛŒØ±ØŒ Ú†Ø§ØŒ Ø®ÙˆØ§Ø±Ø¯Ù†ØŒ Ø®ÙˆØ§Ø±Ø¯Ù†Û•ÙˆÛ•ØŒ Ø¬Ù„ØŒ Ù¾ÛÚµØ§ÙˆØŒ Ú©ÚµØ§ÙˆØŒ Ø¨Û•Ø±Ú¯ØŒ Ú•Û•Ù†Ú¯ØŒ Ø³Ù¾ÛŒØŒ Ú•Û•Ø´ØŒ Ø³ÙˆÙˆØ±ØŒ Ø´ÛŒÙ†ØŒ Ø²Û•Ø±Ø¯ØŒ Ú©Û•Ø³Ú©ØŒ Ù…Û†Ø±ØŒ Ù‚Ø§ÙˆÛ•ÛŒÛŒØŒ Ù¾ÛŒØ±Û†Ø²ØŒ Ø¬ÙˆØ§Ù†ØŒ Ù†Ø§Ø´Ø±ÛŒÙ†ØŒ Ø¨Ø§Ø´ØŒ Ø®Ø±Ø§Ù¾ØŒ Ú¯Û•ÙˆØ±Û•ØŒ Ø¨Ú†ÙˆÙˆÚ©ØŒ Ú©Û†Ù†ØŒ Ù†ÙˆÛØŒ Ø¯Ø±ÛÚ˜ØŒ Ú©ÙˆØ±ØªØŒ Ù‚ÙˆØ±Ø³ØŒ Ø³ÙˆÙˆÚ©ØŒ Ú¯Û•Ø±Ù…ØŒ Ø³Ø§Ø±Ø¯ØŒ ÙˆØ´Ú©ØŒ ØªÛ•Ú•ØŒ Ø¨Û•Ø±Ø²ØŒ Ù†Ø²Ù…ØŒ Ø¯ÙˆÙˆØ±ØŒ Ù†Ø²ÛŒÚ©ØŒ Ø²Û†Ø±ØŒ Ú©Û•Ù…ØŒ Ù‡Û•Ù…ÙˆÙˆØŒ Ù‡ÛŒÚ†ØŒ Ø¦ÛÙ…Û•ØŒ Ø¦ÛÙˆÛ•ØŒ Ø¦Û•ÙˆØ§Ù†ØŒ Ù…Ù†ØŒ ØªÛ†ØŒ Ø¦Û•ÙˆØŒ Ø¦Û•Ù…Ú•Û†ØŒ Ø¯ÙˆÛÙ†ÛØŒ Ø³Ø¨Û•ÛŒØŒ Ø¦ÛØ³ØªØ§ØŒ Ø¯ÙˆØ§ØªØ±ØŒ Ù¾ÛØ´ØªØ±ØŒ Ú˜ÙˆÙˆØ±ØŒ Ø¯Û•Ø±Û•ÙˆÛ•ØŒ Ø³Û•Ø±Û•ÙˆÛ•ØŒ Ø®ÙˆØ§Ø±Û•ÙˆÛ•ØŒ Ù†Ø§ÙˆØŒ Ø¯Û•Ø±Û•ÙˆÛ•ØŒ Ù„Ø§ÛŒ Ú•Ø§Ø³ØªØŒ Ù„Ø§ÛŒ Ú†Û•Ù¾ØŒ Ù¾ÛØ´ØŒ Ø¯ÙˆØ§ØŒ Ù„Û•Ú¯Û•ÚµØŒ Ø¨ÛØŒ Ø¨Û†ØŒ Ù„Û•ØŒ Ø¨Û•ØŒ ÙˆØŒ ÛŒØ§Ù†ØŒ Ø¨Û•ÚµØ§Ù…ØŒ Ú†ÙˆÙ†Ú©Û•ØŒ Ø¦Û•Ú¯Û•Ø±ØŒ Ú©Û•ØŒ Ú†Û†Ù†ØŒ Ú©Û•ÛŒØŒ Ù„Û•Ú©ÙˆÛØŒ Ø¨Û†Ú†ÛŒØŒ Ú©ÛØŒ Ú†ÛŒØŒ Ú†Û•Ù†Ø¯ØŒ Ù‡Û•Ø±ØŒ Ù‡Û•ØªØ§ØŒ Ø²Ù…Ø§Ù†ØŒ Ú©ÙˆØ±Ø¯ÛŒØŒ Ú©ÙˆØ±Ø¯Ø³ØªØ§Ù†ØŒ Ù†ÛŒØ´ØªÙ…Ø§Ù†ØŒ ÙˆÚµØ§ØªØŒ Ú¯Û•Ù„ØŒ Ù†Û•ØªÛ•ÙˆÛ•ØŒ Ù…ÛÚ˜ÙˆÙˆØŒ Ú©Û•Ù„ØªÙˆÙˆØ±ØŒ Ù‡ÙˆÙ†Û•Ø±ØŒ Ú¯Û†Ø±Ø§Ù†ÛŒØŒ Ø´ÛŒØ¹Ø±ØŒ Ú†ÛŒØ±Û†Ú©ØŒ Ú•Û†Ù…Ø§Ù†ØŒ Ø´Ø§Ù†Û†ØŒ ÙÛŒÙ„Ù…ØŒ Ù…Û†Ø³ÛŒÙ‚Ø§ØŒ ÙˆÛÙ†Û•ØŒ Ø¬Û•Ú˜Ù†ØŒ Ø¦Ø§Ù‡Û•Ù†Ú¯ØŒ Ø´Ø§Ø¯ÛŒØŒ Ø®Û•Ù…ØŒ Ú¯Ø±ÛŒØ§Ù†ØŒ Ù¾ÛÚ©Û•Ù†ÛŒÙ†ØŒ ØªØ±Ø³ØŒ Ø¦Ø§Ø²Ø§ÛŒÛ•ØªÛŒØŒ Ù‡ÛŒÙˆØ§ØŒ Ø®Û•ÙˆÙ†ØŒ Ø¨ÛŒØ±ØŒ Ù‡Ø²Ø±ØŒ ÙÛ•Ù„Ø³Û•ÙÛ•ØŒ Ø²Ø§Ù†Ø³ØªØŒ ØªÛ•Ú©Ù†Û•Ù„Û†Ú˜ÛŒØ§ØŒ Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±ØŒ Ù…Û†Ø¨Ø§ÛŒÙ„ØŒ Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØªØŒ ØªÛ†Ú•ÛŒ Ú©Û†Ù…Û•ÚµØ§ÛŒÛ•ØªÛŒØŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒØŒ Ù‡Ø§ØªÙˆÚ†Û†ØŒ Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„ØŒ ÙÚ•Û†Ú©Û•ØŒ Ù¾Ø§Ø³ØŒ Ø´Û•Ù…Û•Ù†Ø¯Û•ÙÛ•Ø±ØŒ Ø³Ø±ÙˆØ´ØªØŒ Ø¯Ø§Ø±Ø³ØªØ§Ù†ØŒ Ú†ÛŒØ§ØŒ Ø¯Û•Ø´ØªØŒ Ú•ÙˆÙˆØ¨Ø§Ø±ØŒ Ø¯Û•Ø±ÛŒØ§ØŒ Ú¯ÙˆÚµØŒ Ø¯Ø§Ø±ØŒ Ú¯ÛŒØ§ØŒ Ú¯ÛŒØ§Ù†Ø¯Ø§Ø±ØŒ Ø¨Ø§ÚµÙ†Ø¯Û•ØŒ Ù…Ø§Ø³ÛŒØŒ Ù…Ø§Ø±ØŒ Ù…ÛØ±ÙˆÙˆØŒ Ù…ÛØ´ØŒ Ù…ÛØ±ÙˆÙ„Û•ØŒ Ù¾Ø´ÛŒÙ„Û•ØŒ Ø³Û•Ú¯ØŒ Ù…Ø§Ù†Ú¯Ø§ØŒ Ø¨Ø²Ù†ØŒ Ù…Û•Ú•ØŒ Ø¦Û•Ø³Ù¾ØŒ ÙÛŒÙ„ØŒ Ø´ÛØ±ØŒ Ú¯ÙˆØ±Ú¯ØŒ Ú•ÛÙˆÛŒØŒ Ú©Û•Ø±ÙˆÛØ´Ú©ØŒ Ù…Ø´Ú©ØŒ Ù¾Û•Ú•Û•Ø³ÛÙ„Ú©Û•ØŒ Ú©Û†ØªØ±ØŒ Ù‡Û•ÚµÛ†ØŒ Ù‚Ø§Ø²ØŒ Ù…Ø±Ø§ÙˆÛŒØŒ Ú©Û•ÙˆØŒ Ø³ÛŒØ§Ø³Û•ØªØŒ Ø­Ú©ÙˆÙ…Û•ØªØŒ Ù¾Û•Ø±Ù„Û•Ù…Ø§Ù†ØŒ ÛŒØ§Ø³Ø§ØŒ Ø¯Ø§Ø¯Ú¯Ø§ØŒ Ù¾Û†Ù„ÛŒØ³ØŒ Ø³Û•Ø±Ø¨Ø§Ø²ØŒ Ø¬Û•Ù†Ú¯ØŒ Ø¦Ø§Ø´ØªÛŒØŒ Ø³Û•Ø±Ø¨Û•Ø®Û†ÛŒÛŒØŒ Ø¯ÛŒÙ…ÙˆÚ©Ø±Ø§Ø³ÛŒØŒ Ù…Ø§ÙÛŒ Ù…Ø±Û†Ú¤ØŒ Ø¯Ø§Ø¯Ù¾Û•Ø±ÙˆÛ•Ø±ÛŒØŒ ÛŒÛ•Ú©Ø³Ø§Ù†ÛŒØŒ Ø¦Ø§Ø¨ÙˆÙˆØ±ÛŒØŒ Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒØŒ Ú©Ø´ØªÙˆÚ©Ø§ÚµØŒ Ù¾ÛŒØ´Û•Ø³Ø§Ø²ÛŒØŒ Ú©Ø§Ù†Ø²Ø§ØŒ Ù†Û•ÙˆØªØŒ Ú©Ø§Ø±Û•Ø¨Ø§ØŒ ÙˆØ²Û•ØŒ Ø¦Ø§ÙˆØŒ ØªÛ•Ù†Ø¯Ø±ÙˆØ³ØªÛŒØŒ Ù†Û•Ø®Û†Ø´ÛŒØŒ Ø¯Û•Ø±Ù…Ø§Ù†ØŒ Ù†Û•Ø®Û†Ø´Ø®Ø§Ù†Û•ØŒ Ù¾Ø²ÛŒØ´Ú©ØŒ Ø¯Ú©ØªÛ†Ø±ØŒ Ø¯Û•Ø±Ù…Ø§Ù†Ø®Ø§Ù†Û•ØŒ ÙˆØ±Ø²Ø´ØŒ ØªÛ†Ù¾ÛŒ Ù¾ÛØŒ Ø¨Ø§Ø³Ú©Û•ØŒ ØªÛÙ†Ø³ØŒ Ù…Û•Ù„Û•ÙˆØ§Ù†ÛŒØŒ Ú•Ø§Ú©Ø±Ø¯Ù†ØŒ Ø¨Ø§Ø²Ø¯Ø§Ù†ØŒ Ù‡Û•ÚµÚ¯Ø±ØªÙ†ØŒ ÙÚ•ÛŒÙ†ØŒ Ú•Û†ÛŒØ´ØªÙ†ØŒ Ù‡Ø§ØªÙ†ØŒ Ú†ÙˆÙˆÙ†ØŒ ÙˆÛ•Ø³ØªØ§Ù†ØŒ Ø¯Ø§Ù†ÛŒØ´ØªÙ†ØŒ Ù‡Û•Ø³ØªØ§Ù†ØŒ Ø®Û•ÙˆØªÙ†ØŒ Ø®ÙˆØ§Ø±Ø¯Ù†ØŒ Ø®ÙˆØ§Ø±Ø¯Ù†Û•ÙˆÛ•ØŒ Ø¨ÛŒÙ†ÛŒÙ†ØŒ Ø¨ÛŒØ³ØªÙ†ØŒ Ù‡Û•Ø³Øª Ù¾ÛÚ©Ø±Ø¯Ù†ØŒ Ø¨Û†Ù† Ú©Ø±Ø¯Ù†ØŒ ØªØ§Ù… Ú©Ø±Ø¯Ù†ØŒ Ù‚Ø³Û• Ú©Ø±Ø¯Ù†ØŒ Ù†ÙˆÙˆØ³ÛŒÙ†ØŒ Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•ØŒ ÙÛØ±Ø¨ÙˆÙˆÙ†ØŒ Ø¨ÛŒØ±Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ØŒ Ø®Û†Ø´Û•ÙˆÛŒØ³ØªÛŒØŒ Ú•Ù‚ØŒ Ø¦ÛŒØ±Û•ÛŒÛŒØŒ Ø´Û•Ø±Ù…ØŒ Ø´Ø§Ù†Ø§Ø²ÛŒØŒ Ø¨Û•Ø®ØªÛ•ÙˆÛ•Ø±ÛŒØŒ Ù†Ø§Ø®Û†Ø´ÛŒØŒ Ú˜ÛŒØ§Ù†ØŒ Ù…Ø±Ø¯Ù†ØŒ Ù„Û•Ø¯Ø§ÛŒÚ©Ø¨ÙˆÙˆÙ†ØŒ Ú¯Û•Ø´Û•Ú©Ø±Ø¯Ù†ØŒ Ù¾ÛŒØ±Ø¨ÙˆÙˆÙ†ØŒ ØªÛ•Ù…Û•Ù†ØŒ Ø³Ø§ÚµØŒ Ù…Ø§Ù†Ú¯ØŒ Ù‡Û•ÙØªÛ•ØŒ Ú•Û†Ú˜ØŒ Ú©Ø§ØªÚ˜Ù…ÛØ±ØŒ Ø®ÙˆÙ„Û•Ú©ØŒ Ú†Ø±Ú©Û•ØŒ Ú©Ø§ØªØŒ Ø´ÙˆÛÙ†ØŒ Ø¨Û†Ø´Ø§ÛŒÛŒØŒ Ø¬ÛŒÙ‡Ø§Ù†ØŒ Ú¯Û•Ø±Ø¯ÙˆÙˆÙ†ØŒ Ø²Û•ÙˆÛŒ`;
        const wordsList = rawWords.split('ØŒ').map(w => w.trim()).filter(w => w.length > 0);

        // --- STATE ---
        let playerNames = [];
        let gameSession = [];
        let currentIndex = 0;
        let isCardFlipped = false;
        let isProcessing = false;
        let timerInterval = null;

        // --- UI ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            timer: document.getElementById('timer-screen'),
            end: document.getElementById('end-screen')
        };
        const ui = {
            input: document.getElementById('name-input'),
            list: document.getElementById('names-list'),
            spies: document.getElementById('num-spies'),
            timeInput: document.getElementById('game-timer'),
            error: document.getElementById('error-msg'),
            card: document.getElementById('game-card'),
            role: document.getElementById('role-text'),
            word: document.getElementById('word-text'),
            desc: document.getElementById('role-desc'),
            badge: document.getElementById('player-indicator'),
            timerDisplay: document.getElementById('timer-display'),
            revealList: document.getElementById('spies-reveal-list')
        };

        // --- NAVIGATION CONTROLLER (THE FIX) ---
        function showScreen(screenElement) {
            // 1. Force Hide All Screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });

            // 2. Show Target Screen
            screenElement.classList.add('active');
        }

        // --- SETUP ---
        function handleEnter(e) { if (e.key === 'Enter') addName(); }

        function addName() {
            const name = ui.input.value.trim();
            if (name.length > 0 && !playerNames.includes(name)) {
                playerNames.push(name);
                ui.input.value = '';
                ui.input.focus();
                renderNames();
                ui.error.textContent = '';
            }
        }

        function removeName(index) {
            playerNames.splice(index, 1);
            renderNames();
        }

        function renderNames() {
            ui.list.innerHTML = '';
            playerNames.forEach((name, index) => {
                ui.list.innerHTML += `<div class="name-tag">${name} <i class="fas fa-times" onclick="removeName(${index})"></i></div>`;
            });
        }

        // --- GAME LOGIC ---
        function startGame() {
            const numSpies = parseInt(ui.spies.value);
            if (playerNames.length < 3) return ui.error.textContent = "Ù„Ø§Ù†ÛŒ Ú©Û•Ù… Ù†Ø§ÙˆÛŒ Ù£ ÛŒØ§Ø±ÛŒØ²Ø§Ù† Ø¨Ù†ÙˆÙˆØ³Û•";
            if (numSpies >= playerNames.length) return ui.error.textContent = "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³ÛŒØ®ÙˆÚ• Ø²Û†Ø±Û•!";

            // Setup Data
            const targetWord = wordsList[Math.floor(Math.random() * wordsList.length)];
            let shuffledNames = [...playerNames].sort(() => Math.random() - 0.5);
            let roles = Array(numSpies).fill('spy').concat(Array(playerNames.length - numSpies).fill('citizen')).sort(() => Math.random() - 0.5);

            gameSession = shuffledNames.map((name, i) => ({
                name: name,
                role: roles[i],
                word: roles[i] === 'spy' ? 'ğŸ˜' : targetWord
            }));

            currentIndex = 0;
            isCardFlipped = false;
            isProcessing = false;
            ui.card.className = 'card';
            resetCardText();
            updateBadge();

            showScreen(screens.game);
        }

        function handleCardInteraction() {
            if (isProcessing) return;
            isProcessing = true;
            ui.card.classList.add('disabled');

            if (!isCardFlipped) {
                // FLIP OPEN
                const player = gameSession[currentIndex];
                ui.word.textContent = player.word;
                if (player.role === 'spy') {
                    ui.role.textContent = "Ø³ÛŒØ®ÙˆÚ•";
                    ui.desc.textContent = "ØªÛ† Ø³ÛŒØ®ÙˆÚ•ÛŒØª! Ù…Û•Ù‡ÛÚµÛ• Ú©Û•Ø³ Ø¨Ø²Ø§Ù†ÛØª.";
                    ui.card.classList.add('spy-active');
                } else {
                    ui.role.textContent = "Ù‡Ø§ÙˆÚµØ§ØªÛŒ";
                    ui.desc.textContent = "ÙˆØ´Û•Ú©Û• Ø¨Ù¾Ø§Ø±ÛØ²Û•.";
                    ui.card.classList.remove('spy-active');
                }
                ui.card.classList.add('is-flipped');
                isCardFlipped = true;
                setTimeout(() => { isProcessing = false; ui.card.classList.remove('disabled'); }, 500);
            } else {
                // FLIP CLOSE
                ui.card.classList.remove('is-flipped');
                isCardFlipped = false;
                setTimeout(() => {
                    ui.card.classList.remove('spy-active');
                    resetCardText();
                    currentIndex++;
                    
                    if (currentIndex >= gameSession.length) {
                        startTimer();
                    } else {
                        updateBadge();
                        isProcessing = false;
                        ui.card.classList.remove('disabled');
                    }
                }, 600);
            }
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            showScreen(screens.timer);
            
            let minutes = parseInt(ui.timeInput.value) || 5;
            let seconds = minutes * 60;
            
            updateTimerDisplay(seconds);

            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                seconds--;
                updateTimerDisplay(seconds);
                
                if (seconds <= 0) {
                    finishGame();
                }
            }, 1000);
        }

        function updateTimerDisplay(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            ui.timerDisplay.textContent = `${m}:${s}`;
            
            if (totalSeconds < 10) ui.timerDisplay.style.color = 'var(--accent)';
            else ui.timerDisplay.style.color = 'white';
        }

        // --- FINISH ---
        function finishGame() {
            if(timerInterval) clearInterval(timerInterval);
            navigator.vibrate?.([200, 100, 200]); 
            
            const spies = gameSession.filter(p => p.role === 'spy');
            ui.revealList.innerHTML = spies.map(s => `<span class="imposter-tag">${s.name}</span>`).join('');

            showScreen(screens.end);
            createConfetti();
        }

        // --- RESTART LOGIC ---
        function restartSamePlayers() { 
            if(timerInterval) clearInterval(timerInterval);
            startGame(); 
        }

        function editPlayers() { 
            if(timerInterval) clearInterval(timerInterval);
            showScreen(screens.setup); 
        }

        function resetGame() {
            if(timerInterval) clearInterval(timerInterval);
            playerNames = [];
            renderNames();
            showScreen(screens.setup);
        }

        // UTILS
        function resetCardText() { ui.role.textContent = "..."; ui.word.textContent = "..."; ui.desc.textContent = "..."; }
        function updateBadge() { if(gameSession[currentIndex]) ui.badge.innerHTML = `<i class="fas fa-user"></i> ${gameSession[currentIndex].name}`; }

        function createConfetti() {
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.classList.add('confetti');
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.animationDuration = Math.random() * 2 + 3 + 's';
                conf.style.backgroundColor = ['#f43f5e', '#6366f1', '#10b981', '#f59e0b'][Math.floor(Math.random()*4)];
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 5000);
            }
        }
    </script>
</body>
</html>
