<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سیخوڕ - Spy Game</title>
code
Code

download

content_copy

expand_less
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- PeerJS for Online Multiplayer -->
<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

<style>
    /* --- RESET & VARIABLES --- */
    :root {
        --bg: #0f172a;
        --primary: #6366f1;
        --primary-dark: #4338ca;
        --accent: #f43f5e;
        --success: #10b981;
        --glass: rgba(255, 255, 255, 0.07);
        --glass-border: rgba(255, 255, 255, 0.12);
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --card-front-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        --gold: #f59e0b;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Vazirmatn', sans-serif; user-select: none; outline: none; }
    
    body {
        margin: 0; padding: 0; 
        height: 100vh; height: 100dvh;
        background-color: var(--bg);
        overflow: hidden; color: var(--text);
        display: flex; align-items: center; justify-content: center;
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 20%),
            radial-gradient(circle at 90% 80%, rgba(244, 63, 94, 0.15) 0%, transparent 20%);
    }

    /* --- ANIMATIONS --- */
    @keyframes textShine {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }
    
    .shimmer-text {
        background: linear-gradient(120deg, var(--text) 40%, #a5b4fc 50%, var(--text) 60%);
        background-size: 200% auto;
        color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        animation: textShine 4s linear infinite;
    }

    @keyframes shimmer-sweep {
        0% { transform: translateX(-150%) skewX(-25deg); }
        40% { transform: translateX(150%) skewX(-25deg); }
        100% { transform: translateX(150%) skewX(-25deg); }
    }

    @keyframes glow-pulse {
        0% { box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.5); }
        50% { box-shadow: 0 10px 40px -5px rgba(99, 102, 241, 0.8); }
        100% { box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.5); }
    }

    @keyframes float { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100px) scale(1); opacity: 0; } }
    @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounceIn { 0% { opacity:0; transform: scale(0.8); } 60% { transform: scale(1.05); } 100% { opacity:1; transform: scale(1); } }
    @keyframes pulse { 0%,100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.1); opacity: 0.5; } }

    /* --- TOAST NOTIFICATION --- */
    .toast-container {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none;
    }
    .toast-box {
        background: rgba(15, 23, 42, 0.95); border: 1px solid var(--accent); border-left: 5px solid var(--accent);
        color: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex; align-items: center; gap: 15px; font-size: 0.95rem;
        animation: toastEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, shake 0.4s 0.2s;
        pointer-events: all; backdrop-filter: blur(10px);
    }
    .toast-box.hiding { animation: toastExit 0.4s forwards; }
    .toast-icon { font-size: 1.5rem; color: var(--accent); animation: pulse 1s infinite; }
    @keyframes toastEnter { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastExit { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-20px) scale(0.9); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-5px); } 40% { transform: translateX(5px); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }

    /* --- BACKGROUND PARTICLES --- */
    .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.5; }
    .particle { position: absolute; border-radius: 50%; background: white; opacity: 0.3; animation: float infinite linear; }

    /* --- APP WRAPPER --- */
    .app-wrapper {
        width: 100%; height: 100%; 
        position: relative; z-index: 10;
        display: flex; flex-direction: column;
        transition: max-width 0.3s ease;
    }

    @media (min-width: 768px) {
        .app-wrapper {
            max-width: 1000px; height: 95vh;
            border-radius: 24px; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border);
            background: rgba(15, 23, 42, 0.6);
        }
    }

    /* --- VIEWS --- */
    .view {
        position: absolute; inset: 0;
        display: flex; flex-direction: column; align-items: center;
        padding: 15px 20px;
        background: rgba(15, 23, 42, 0.95);
        opacity: 0; pointer-events: none; transform: scale(0.95);
        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @media (min-width: 768px) { .view { background: transparent; padding: 40px; } }
    .view.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 5; }
    
    .scroll-content { 
        width: 100%; overflow-y: auto; flex: 1; padding-bottom: 20px; 
        display: flex; flex-direction: column; align-items: center; 
    }
    .scroll-content::-webkit-scrollbar { width: 6px; }
    .scroll-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

    /* --- UI ELEMENTS --- */
    h1 { 
        margin: 0 0 5px 0; font-size: 1.8rem; font-weight: 900; text-align: center;
        background: linear-gradient(120deg, #fff 40%, #818cf8 50%, #fff 60%);
        background-size: 200% auto;
        color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        animation: textShine 5s linear infinite;
    }
    h2 { 
        font-size: 1.4rem; margin: 10px 0; text-align: center; 
        background: linear-gradient(120deg, #fff 40%, #c7d2fe 50%, #fff 60%);
        background-size: 200% auto;
        color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        animation: textShine 6s linear infinite;
    }
    .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; font-weight: 400; text-align: center; }
    
    .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 40px; }
    .center-icons { display: flex; gap: 15px; }

    .icon-btn { 
        background: var(--glass); border: 1px solid var(--glass-border); color: #fff; 
        width: 40px; height: 40px; border-radius: 12px; display: grid; place-items: center; 
        cursor: pointer; transition: 0.3s; 
    }
    .icon-btn:hover { box-shadow: 0 0 15px rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); transform: scale(1.05); }
    .icon-btn:active { transform: scale(0.9); background: var(--primary); }

    .input-box { width: 100%; max-width: 600px; position: relative; margin-bottom: 20px; display: flex; gap: 8px; }
    .main-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 12px; color: white; font-size: 1rem; text-align: right; }
    .main-input:focus { border-color: var(--primary); }
    
    .add-btn { width: 50px; background: var(--primary); border: none; border-radius: 16px; color: white; font-size: 1.2rem; cursor: pointer; position: relative; overflow: hidden; }
    .add-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 200%; height: 100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.6), transparent); transform: skewX(-25deg); animation: shimmer-sweep 3s infinite linear; pointer-events: none; }
    
    .stacked-inputs { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .stacked-buttons { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }

    .tags-container { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
    
    /* UPDATED TAGS WITH STATUS DOTS */
    .tag { background: rgba(255,255,255,0.1); padding: 8px 12px 8px 16px; border-radius: 30px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
    .tag i { opacity: 0.5; cursor: pointer; padding: 4px; }
    
    /* Connection Status Dot */
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    .status-online { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
    .status-offline { background-color: #94a3b8; }
    
    .kick-btn { margin-right: 5px; width: 24px; height: 24px; background: rgba(244, 63, 94, 0.2); color: var(--accent); border-radius: 50%; display: grid; place-items: center; cursor: pointer; font-size: 0.7rem; }
    .kick-btn:hover { background: var(--accent); color: white; }

    .section-title { width: 100%; text-align: right; font-size: 0.9rem; color: var(--text-muted); margin: 10px 0; font-weight: 700; max-width: 800px; }
    .topics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin-bottom: 10px; }
    @media (min-width: 600px) { .topics-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } }

    .topic-card {
        background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 16px;
        text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
    }
    .topic-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .topic-card.selected { background: rgba(99, 102, 241, 0.2); border-color: var(--primary); box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.2); }
    .topic-card.selected::before { content: ''; position: absolute; top: 0; left: 0; width: 200%; height: 100%; background: linear-gradient(to right, transparent, rgba(99, 102, 241, 0.4), transparent); transform: skewX(-25deg); animation: shimmer-sweep 2.5s infinite; pointer-events: none; }
    .topic-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 8px; right: 8px; font-size: 0.8rem; color: var(--primary); }
    .topic-card i { font-size: 1.5rem; margin-bottom: 5px; }

    #custom-words-container { width: 100%; max-width: 600px; margin-bottom: 20px; display: none; animation: slideDown 0.3s forwards; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 16px; border: 1px dashed var(--glass-border); }
    #custom-words-input { width: 100%; min-height: 70px; background: transparent; color: white; border: none; resize: vertical; font-size: 0.9rem; outline: none; }
    
    .control-row { display: flex; justify-content: space-between; width: 100%; max-width: 600px; align-items: center; background: var(--glass); padding: 12px 15px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 10px; }
    .stepper { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 12px; }
    .step-btn { color: var(--text); background: none; border: none; font-size: 1.1rem; width: 30px; cursor: pointer; }
    .step-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .step-val { font-weight: 900; width: 20px; text-align: center; }

    .primary-btn {
        width: 100%; max-width: 400px;
        background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        color: white; border: none; padding: 16px; border-radius: 20px;
        font-size: 1.1rem; font-weight: 700;
        cursor: pointer; margin-top: 5px; z-index: 100;
        position: relative; overflow: hidden; transition: 0.2s;
        display: flex; justify-content: center; align-items: center; gap: 10px; flex-shrink: 0;
        animation: glow-pulse 3s infinite;
    }
    .primary-btn.secondary { background: var(--glass); border: 1px solid var(--glass-border); animation: none; }
    .primary-btn.danger { background: rgba(244, 63, 94, 0.2); border: 1px solid var(--accent); color: var(--accent); animation: none; }
    .primary-btn.danger:hover { background: rgba(244, 63, 94, 0.4); }
    .primary-btn.success { background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); color: var(--success); animation: none; }
    .primary-btn.success:hover { background: rgba(16, 185, 129, 0.4); }
    
    .primary-btn span, .primary-btn i { position: relative; z-index: 2; background: linear-gradient(120deg, #fff 40%, #e0e7ff 50%, #fff 60%); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: textShine 3s linear infinite; }
    .primary-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 200%; height: 100%; background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%); transform: skewX(-25deg); animation: shimmer-sweep 3s infinite ease-in-out; pointer-events: none; }
    .primary-btn:active { transform: scale(0.98); }
    .primary-btn:hover { box-shadow: 0 15px 35px -5px rgba(99, 102, 241, 0.7); }
    .primary-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; animation: none; }
    
    .card-wrapper { perspective: 1500px; width: 100%; max-width: 340px; height: 55vh; min-height: 350px; max-height: 550px; margin: 20px 0; transition: all 0.3s ease; }
    @media (min-width: 768px) { .card-wrapper { max-width: 450px; height: 60vh; max-height: 650px; } }
    .game-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; }
    .game-card.flipped { transform: rotateY(180deg); }
    
    .card-face {
        position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
        border-radius: 24px; border: 2px solid var(--glass-border);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 0 30px 60px rgba(0,0,0,0.5); text-align: center;
        background-size: cover; background-position: center;
    }
    .face-front { background: var(--card-front-grad); z-index: 2; }
    .fingerprint { font-size: 5rem; color: rgba(255,255,255,0.1); margin-bottom: 20px; animation: pulse 2s infinite; }
    .tap-text { color: rgba(255,255,255,0.6); font-size: 1rem; letter-spacing: 2px; text-transform: uppercase; }
    .face-back { transform: rotateY(180deg); background: white; color: #1e293b; padding: 20px; }
    .role-badge { background: #1e293b; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
    .secret-word { font-size: 2.5rem; font-weight: 900; color: #1e293b; line-height: 1.2; margin: 15px 0; word-break: break-word; background: linear-gradient(120deg, #1e293b 40%, #6366f1 50%, #1e293b 60%); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: textShine 3s linear infinite; }
    .face-back.spy-mode { background: #111; color: #fff; border: 3px solid var(--accent); }
    .face-back.spy-mode .role-badge { background: var(--accent); color: #fff; }
    .face-back.spy-mode .secret-word { color: var(--accent); font-size: 3.5rem; text-shadow: 0 0 20px rgba(244, 63, 94, 0.4); margin: 30px 0; background: linear-gradient(120deg, #f43f5e 40%, #fff 50%, #f43f5e 60%); background-size: 200% auto; color: transparent; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

    .timer-ring {
        position: relative; width: 220px; height: 220px; border-radius: 50%;
        display: grid; place-items: center; margin: 30px 0;
        background: conic-gradient(var(--primary) var(--progress, 0%), rgba(255,255,255,0.1) 0);
        transition: background 0.1s linear;
    }
    @media (min-width: 768px) { .timer-ring { width: 300px; height: 300px; } .time-text { font-size: 5rem !important; } }
    .timer-ring::before { content:''; position: absolute; inset: 10px; border-radius: 50%; background: var(--bg); }
    .time-text { position: relative; font-size: 3.5rem; font-weight: 900; font-variant-numeric: tabular-nums; }
    
    .starter-box { background: linear-gradient(135deg, #1e293b, #0f172a); padding: 30px; border-radius: 24px; border: 1px solid var(--glass-border); text-align: center; margin: auto; box-shadow: 0 30px 80px rgba(0,0,0,0.7); transform: scale(0.9); animation: bounceIn 0.5s forwards; width: 90%; max-width: 400px; }
    .starter-avatar { width: 70px; height: 70px; background: var(--gold); border-radius: 50%; margin: 0 auto 15px; display: grid; place-items: center; font-size: 2rem; color: #000; }
    
    .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 50; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content { width: 90%; max-width: 500px; background: #1e293b; padding: 25px; border-radius: 24px; max-height: 85%; overflow-y: auto; border: 1px solid var(--glass-border); position: relative; }
    .modal-close { position: absolute; top: 15px; right: 15px; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; cursor: pointer; }
    
    .rule-item { display: flex; gap: 12px; margin-bottom: 15px; align-items: center; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
    .rule-icon { width: 35px; height: 35px; background: rgba(255,255,255,0.1); border-radius: 8px; display: grid; place-items: center; color: var(--primary); flex-shrink: 0; }
    
    .social-container { width: 100%; display: flex; justify-content: center; gap: 20px; margin-top: 15px; padding-top: 10px; }
    .social-container a { transition: transform 0.2s; display: block; }
    .social-container a:hover { transform: scale(1.2); }

    .results-card { background: rgba(255,255,255,0.05); width: 100%; max-width: 600px; border-radius: 16px; padding: 15px; margin: 20px 0; }
    .spy-reveal { display: flex; align-items: center; justify-content: space-between; background: rgba(244, 63, 94, 0.2); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid rgba(244, 63, 94, 0.5); }
    .result-phase-container { width: 100%; display: flex; flex-direction: column; align-items: center; }

    /* Attempts Display */
    .attempts-display {
        background: rgba(99, 102, 241, 0.15); border: 1px solid var(--primary);
        color: #fff; padding: 10px 20px; border-radius: 12px;
        font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;
        display: flex; align-items: center; gap: 10px;
    }

    .status-box { width: 100%; max-width: 600px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; text-align: center; margin-bottom: 20px; font-weight: bold; min-height: 54px; border: 1px solid var(--glass-border); }
    .status-box.success { background: rgba(16, 185, 129, 0.2); color: var(--success); border-color: var(--success); }
    .status-box.error { background: rgba(244, 63, 94, 0.2); color: var(--accent); border-color: var(--accent); }
    
    .suspect-card {
        background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 16px;
        text-align: center; cursor: pointer; transition: 0.3s; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .suspect-card:active { transform: scale(0.95); }
    .suspect-card:hover { background: rgba(255,255,255,0.1); }
    .suspect-card.eliminated { opacity: 0.3; pointer-events: none; filter: grayscale(1); transform: scale(0.9); }
    .suspect-card.caught { background: var(--accent); border-color: var(--accent); pointer-events: none; }
    .suspect-card.selected-vote { background: rgba(99, 102, 241, 0.4); border-color: var(--primary); transform: scale(1.02); box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
    
    .voter-badge { position: absolute; bottom: 5px; right: 5px; background: var(--primary); width: 24px; height: 24px; border-radius: 50%; font-size: 0.7rem; display: grid; place-items: center; border: 1px solid white; z-index: 10;}

    /* FIXED PAUSE BUTTON CONTAINER */
    #host-timer-controls { display: flex; justify-content: center; gap: 15px; width: 100%; align-items: center; margin-bottom: 20px; }

    .winner-header { text-align: center; margin-top: 20px; }
    .winner-header i { font-size: 3rem; margin-bottom: 10px; }
    .winner-citizens i { color: var(--success); }
    .winner-citizens h1 { background: linear-gradient(120deg, #10b981 40%, #fff 50%, #10b981 60%); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; }
    .winner-spies i { color: var(--accent); }
    .winner-spies h1 { background: linear-gradient(120deg, #f43f5e 40%, #fff 50%, #f43f5e 60%); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; }

    .footer { width: 100%; text-align: center; padding: 15px 0 5px 0; font-size: 0.75rem; color: rgba(255,255,255,0.4); letter-spacing: 1px; text-transform: uppercase; }
    .footer b { color: var(--primary); font-weight: 900; }
    
    .waiting-message { font-size: 1.2rem; color: var(--text-muted); animation: pulse 1s infinite; margin-top: 20px; text-align: center;}
    
    @media (max-height: 600px) {
        h1 { font-size: 1.4rem; }
        .card-wrapper { height: 60vh; min-height: 250px; }
        .timer-ring { width: 160px; height: 160px; margin: 10px 0; }
        .time-text { font-size: 2.5rem; }
        .topics-grid { grid-template-columns: repeat(3, 1fr); } 
        .view { padding: 10px 20px; }
    }
</style>
</head>
<body>
code
Code

download

content_copy

expand_less
<!-- Particles BG -->
<div class="particles" id="particles"></div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="toast-container"></div>

<!-- App Container -->
<div class="app-wrapper">

    <!-- VIEW 0: MODE SELECTION -->
    <div id="view-mode" class="view active">
         <div class="scroll-content" style="justify-content: center;">
            <h1 style="font-size: 2.5rem; margin-bottom: 10px;">سیخوڕ</h1>
            <p class="subtitle">یەکێک لەم شێوازانە هەڵبژێرە</p>
            
            <button class="primary-btn" onclick="startLocalMode()">
                <span>یاریکردن بە یەک مۆبایل</span> <i class="fas fa-mobile-alt"></i>
            </button>
            <div style="margin: 10px; color: var(--text-muted); font-size: 0.8rem;">--- یان ---</div>
            <button class="primary-btn secondary" onclick="transitionTo('view-lobby-entry')">
                <span>یاریکردن بە ئۆنڵاین</span> <i class="fas fa-wifi"></i>
            </button>
            
            <div class="footer">Made by <a href="https://instagram.com/baxnasi7" target="_blank"> <b>Bawan</b> </a></div>
         </div>
    </div>

    <!-- VIEW 0.5: LOBBY ENTRY -->
    <div id="view-lobby-entry" class="view">
        <div class="top-bar">
            <div class="icon-btn" onclick="transitionTo('view-mode')"><i class="fas fa-arrow-right"></i></div>
        </div>
        <div class="scroll-content" style="justify-content: center;">
            <h2>سەرەتا</h2>
            <p class="subtitle">زانیاریەکانت پڕبکەرەوە</p>
            
            <!-- Stacked Inputs -->
            <div class="stacked-inputs">
                <input type="text" id="my-name-input" class="main-input" placeholder="ناوەکەت..." style="text-align: center; width: 100%; margin:0;">
                <input type="text" id="room-code-input" class="main-input" placeholder="کۆدی ژوور (بۆ دروستکردن یان چوونەژوور)" style="text-align: center; letter-spacing: 2px; width: 100%; margin:0;">
            </div>
            
            <div style="width: 100%; border-top: 1px solid var(--glass-border); margin: 20px 0; max-width: 400px;"></div>

            <!-- Stacked Buttons -->
            <div class="stacked-buttons">
                <button class="primary-btn" onclick="createOnlineRoom()" style="width: 100%; margin:0;">
                    <span>دروستکردنی ژوور (Server)</span> <i class="fas fa-server"></i>
                </button>
                <button class="primary-btn secondary" onclick="joinOnlineRoom()" style="width: 100%; margin:0;">
                    <span>چوونە ژوورەوە</span> <i class="fas fa-sign-in-alt"></i>
                </button>
            </div>
            
            <p style="margin: 20px 0; font-size: 0.9rem; color: var(--text-muted); text-align: center;">ئەگەر بۆ دروستکردن کۆد نەنوسیت، بەڕێکەوت دروست دەبێت</p>
        </div>
    </div>

    <!-- VIEW 0.7: WAITING LOBBY -->
    <div id="view-lobby-waiting" class="view">
         <div class="top-bar">
             <div class="icon-btn" onclick="exitToMainMenu()"><i class="fas fa-home"></i></div>
         </div>
         <div class="scroll-content">
             <h2>ژووری چاوەڕوانی</h2>
             <div style="background: var(--glass); padding: 10px 20px; border-radius: 12px; border: 1px solid var(--primary); color: var(--primary); font-weight: bold; font-size: 1.5rem; letter-spacing: 3px; margin-bottom: 20px;" id="display-room-code">...</div>
             
             <div class="section-title">یاریزانەکان:</div>
             <div id="lobby-players-list" class="tags-container"></div>
             
             <div id="host-controls" style="width: 100%; display: none; flex-direction: column; align-items: center; gap: 10px;">
                 <p class="subtitle">تۆ سێرڤەریت، کەی هەمووان هاتن دەستپێبکە</p>
                 <button class="primary-btn" onclick="setupOnlineGame()">
                    <span>ڕێکخستن و دەستپێکردن</span> <i class="fas fa-cog"></i>
                </button>
                <!-- Stop Server Button -->
                <button id="btn-lock-room" class="primary-btn danger" onclick="toggleRoomLock()" style="margin-top: 5px;">
                    <span>داخستنی ژوور</span> <i class="fas fa-lock"></i>
                </button>
             </div>
             <div id="client-wait-msg" style="display: none;">
                 <p class="waiting-message">چاوەڕێی سێرڤەر بە یاریەکە دەستپێبکات...</p>
             </div>
         </div>
    </div>

    <!-- VIEW 1: SETUP -->
    <div id="view-setup" class="view">
        <div class="top-bar">
            <div class="icon-btn" onclick="toggleHelp()"><i class="fas fa-question"></i></div>
            <div class="center-icons">
                <div class="icon-btn" onclick="toggleSound()" id="btn-sound"><i class="fas fa-volume-up"></i></div>
                <div class="icon-btn" onclick="toggleHaptics()" id="btn-haptics"><i class="fas fa-mobile-alt"></i></div>
            </div>
            <div class="icon-btn" onclick="exitToMainMenu()" id="btn-exit"><i class="fas fa-home"></i></div>
            <div class="icon-btn" onclick="backToLobby()" id="btn-back-lobby" style="display:none"><i class="fas fa-arrow-right"></i></div>
        </div>

        <div class="scroll-content">
            <h1>یاری سیخوڕەکە</h1>
            <p class="subtitle shimmer-text">کاتی دۆزینەوەی نهێنیەکانە...</p>

            <!-- Topics -->
            <div class="section-title">بابەت هەڵبژێرە (زیاتر لە یەک دانە ئاساییە):</div>
            <div class="topics-grid" id="topics-container"></div>
            
            <!-- Custom Input -->
            <div id="custom-words-container">
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: bold;">وشە تایبەتەکانت بنووسە:</div>
                <textarea id="custom-words-input" placeholder="نموونە: تۆپی پێ، باڵە، مەلەوانی... &#10;یان بە ENTER جیایان بکەوە"></textarea>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4); text-align: left; margin-top:5px;">بە کۆما یان دێڕ جیایان بکەرەوە</div>
            </div>

            <!-- Inputs (Local Mode) -->
            <div id="player-input-section">
                <div class="section-title">لیستی یاریزانان:</div>
                <div class="input-box">
                    <input type="text" id="player-input" class="main-input" placeholder="ناوی یاریزان..." autocomplete="off">
                    <button class="add-btn" onclick="addPlayer()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <!-- Player List -->
            <div id="players-container" class="tags-container"></div>
            
            <!-- Game Controls -->
            <div class="section-title">ڕێکخستنەکان:</div>
            <div class="control-row">
                <div class="control-label"><span>ژمارەی سیخوڕەکان</span></div>
                <div class="stepper">
                    <button class="step-btn" id="btn-spy-down" onclick="adjVal('spy-count', -1)">-</button>
                    <span class="step-val" id="spy-count">1</span>
                    <button class="step-btn" id="btn-spy-up" onclick="adjVal('spy-count', 1)">+</button>
                </div>
            </div>

            <div class="control-row">
                <div class="control-label"><span>کات (خولەک) ماوەی گفتوگۆ</span></div>
                <div class="stepper">
                    <button class="step-btn" id="btn-time-down" onclick="adjVal('game-time', -1)">-</button>
                    <span class="step-val" id="game-time">5</span>
                    <button class="step-btn" id="btn-time-up" onclick="adjVal('game-time', 1)">+</button>
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-label"><span>ژمارەی هەوڵەکان بۆ دۆزینەوەی سیخوڕ</span></div>
                <div class="stepper">
                    <button class="step-btn" id="btn-guess-down" onclick="adjVal('guess-count', -1)">-</button>
                    <span class="step-val" id="guess-count">1</span>
                    <button class="step-btn" id="btn-guess-up" onclick="adjVal('guess-count', 1)">+</button>
                </div>
            </div>
        </div>

        <button class="primary-btn" id="start-btn" onclick="initGame()">
            <span>دەستپێکردن</span> <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- VIEW 2: CARDS -->
    <div id="view-cards" class="view">
        <!-- Add Exit Button Here -->
        <div class="top-bar">
             <div class="icon-btn" onclick="exitToMainMenu()"><i class="fas fa-home"></i></div>
        </div>
        
        <div class="top-bar" style="justify-content: center; margin-top:-50px;">
            <h2 style="margin:0; font-size: 1rem; color:var(--text-muted);">ڕۆڵەکان</h2>
        </div>

        <div class="scroll-content" style="justify-content: center;">
            <div style="text-align:center; margin-bottom: 20px;">
                <div id="current-player-name" class="shimmer-text" style="font-size: 1.4rem; font-weight: bold; margin-bottom: 5px;">Yarizan</div>
                <div id="card-instruction" style="font-size: 0.8rem; color: var(--text-muted);">مۆبایلەکە بدە دەست ئەم کەسە</div>
            </div>

            <div class="card-wrapper">
                <div class="game-card" id="the-card" onclick="flipCard()">
                    <!-- Front -->
                    <div class="card-face face-front">
                        <i class="fas fa-fingerprint fingerprint"></i>
                        <div class="tap-text shimmer-text">کلیـک بـکە</div>
                    </div>
                    <!-- Back -->
                    <div class="card-face face-back" id="card-back">
                        <div class="role-badge" id="card-role">...</div>
                        <div class="secret-word" id="card-word">...</div>
                        <p id="card-desc" style="color:inherit; opacity: 0.7; font-size:0.9rem; margin-top: 10px; padding: 0 10px;">...</p>
                        <div style="position:absolute; bottom:20px; opacity:0.4; font-size: 0.75rem;">دووبارە کلیک بکە بۆ شاردنەوە</div>
                    </div>
                </div>
            </div>
            
            <div id="waiting-others-msg" class="waiting-message" style="display: none; font-size: 1rem;">
                چاوەڕێی یاریزانەکانی تر بە کارتەکانیان ببینن...
            </div>
        </div>
    </div>

    <!-- VIEW 3: STARTER INDICATOR -->
    <div id="view-starter" class="view" style="justify-content: center;">
         <div class="starter-box">
             <p style="color: var(--text-muted); margin-bottom: 15px;">پسیاری یەکەم دەکات:</p>
             <div class="starter-avatar"><i class="fas fa-crown"></i></div>
             <h2 id="starter-name-display" style="font-size: 2rem; color: #fff; margin: 0;">...</h2>
             <br>
             <button class="primary-btn" style="padding: 12px 30px;" onclick="startTimerView()"><span>باشە</span></button>
         </div>
    </div>

    <!-- VIEW 4: TIMER -->
    <div id="view-timer" class="view">
         <div class="top-bar">
             <div class="icon-btn" onclick="exitToMainMenu()"><i class="fas fa-home"></i></div>
             <h2 style="margin:0; flex:1; text-align:center; padding-left:40px;">کات ماوە</h2>
         </div>
         <div class="scroll-content" style="justify-content: center;">
            <div class="timer-ring" id="timer-ring">
                <div class="time-text shimmer-text" id="timer-val">00:00</div>
            </div>
            <p class="subtitle" style="text-align: center;">پرسیار لە یەکتری بکەن بەبێ ئەوەی نهێنییەکە ئاشکرا بکەن!</p>
            
            <!-- Only Host Sees These -->
            <div id="host-timer-controls">
                <button class="icon-btn" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.1); margin-bottom: 10px;" onclick="togglePause()">
                    <i class="fas fa-pause" id="pause-icon"></i>
                </button>
                <button class="primary-btn" style="background: var(--accent); max-width: 200px;" onclick="endGame()">
                    <span>کۆتایی هێنان</span> <i class="fas fa-gavel"></i>
                </button>
            </div>
            <div id="client-timer-msg" style="display: none; color: var(--text-muted); font-size: 0.8rem;">
                تەنها سێرڤەر دەتوانێت کات کۆنتڕۆڵ بکات
            </div>
         </div>
    </div>

    <!-- VIEW 5: RESULTS & VOTING -->
    <div id="view-results" class="view">
         <div class="top-bar">
             <div class="icon-btn" onclick="exitToMainMenu()"><i class="fas fa-home"></i></div>
         </div>
        <div class="scroll-content" style="align-items: stretch; justify-content: start;">
            <!-- Voting Phase -->
            <div id="phase-voting" class="result-phase-container">
                <div style="text-align: center; margin-bottom: 10px;">
                    <i class="fas fa-search" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
                    <h2 style="font-size: 1.5rem;">سیخوڕەکە کێیە؟</h2>
                    <p class="subtitle" style="margin-bottom: 10px;">گومانلێکراو هەڵبژێرە و دەنگ بدە</p>
                </div>
                
                <!-- ATTEMPTS LEFT DISPLAY (Local Only) -->
                <div id="attempts-display" class="attempts-display">
                    <i class="fas fa-bullseye"></i> <span id="attempts-count">0</span> هەوڵ ماوە
                </div>

                <div id="voting-status" class="status-box">تکایە هەمووان دەنگ بدەن</div>
                <div id="suspects-grid" class="topics-grid"></div>
                
                <!-- Online Vote Confirm Button (Client) -->
                <button id="btn-confirm-vote" class="primary-btn" onclick="confirmVote()" style="display: none; margin-top: 20px;">
                     <span>ناردنی دەنگ</span> <i class="fas fa-vote-yea"></i>
                </button>

                <!-- HOST SKIP BUTTON (Online Only) -->
                <button id="btn-force-end" class="primary-btn danger" onclick="hostSkipVoting()" style="display: none; margin-top: 20px; animation: none;">
                     <span>کۆتایی هێنان و ئاشکراکردن</span> <i class="fas fa-eye"></i>
                </button>

                <!-- Reveal Button (Local Mode Only) -->
                <button id="btn-reveal-all" class="primary-btn" style="background: rgba(255,255,255,0.1); margin-top: 20px; font-size: 0.9rem;" onclick="revealEverything('neutral')">
                     <span>هەموویان ئاشکرا بکە</span>
                </button>
                
                <div id="client-reveal-msg" style="display:none; text-align:center; margin-top:10px; opacity:0.6; font-size: 0.9rem;">
                    چاوەڕێی دەنگی ئەوانی تر بە...
                </div>
            </div>

            <!-- Final Results -->
            <div id="phase-post-reveal" class="result-phase-container" style="display: none;">
                <div id="winner-display" class="winner-header"></div>
                <div class="results-card">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">وشەکە ئەمە بوو:</div>
                    <div id="result-word" style="font-size: 1.8rem; font-weight: 900; color: #fff; text-align: center; margin-bottom: 20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);">-</div>
                    <div style="font-size: 0.9rem; color: var(--accent); font-weight: bold;">سیخوڕەکان:</div>
                    <div id="spies-list"></div>
                </div>
                <button class="primary-btn" onclick="resetGameToLobby()"><span>یاری نوێ (هەمان گروپ)</span> <i class="fas fa-redo"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- HELP MODAL -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" onclick="toggleHelp()"><i class="fas fa-times"></i></button>
        <h2>چۆنیەتی یاریکردن</h2>
        <div class="rule-item">
            <div class="rule-icon"><i class="fas fa-user"></i></div>
            <div><b>هاوڵاتی</b><div style="font-size: 0.8rem; color: #aaa;">وشەکەی دەزانێت. دەبێت پرسیار بکات بۆ دۆزینەوەی سیخوڕەکە.</div></div>
        </div>
        <div class="rule-item">
            <div class="rule-icon"><i class="fas fa-user-secret"></i></div>
            <div><b>سیخوڕ</b><div style="font-size: 0.8rem; color: #aaa;">وشەکە نازانێت. دەبێت خۆی وەک هاوڵاتی دەربخات.</div></div>
        </div>
        <div class="rule-item">
            <div class="rule-icon"><i class="fas fa-trophy"></i></div>
            <div><b>بردنەوە</b><div style="font-size: 0.8rem; color: #aaa;">هاوڵاتیان دەیبەنەوە ئەگەر سیخوڕ بدۆزنەوە. سیخوڕ دەیباتەوە ئەگەر بمێنێتەوە یان وشەکە بزانێت.</div></div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <div style="margin-bottom: 10px;"><b>Feedback</b></div>
            <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">بۆ هەر ڕەخنەو تێبینیەک پەیوەندیم پێوە بکەن بە خۆشحاڵیەوە گوێتان لێ دەگرم❤️</div>
            
            <div class="social-container">
                <a href="https://instagram.com/baxnasi7" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Instagram_logo_2016.svg/120px-Instagram_logo_2016.svg.png" width="30"/></a>
                <a href="https://facebook.com/bawannasih" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" width="30"/></a>
                <a href="https://t.me/paperui" target="_blank"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="30"/></a>
            </div>
        </div>
    </div>
</div>

<script>
// --- DATA: WORD CATEGORIES ---
const CATEGORIES = {
    "places": { 
        label: "شوێن", 
        icon: "fa-map-marker-alt", 
        words: ["قوتابخانە", "نەخۆشخانە", "فڕۆکەخانە", "بازاڕ", "مزگەوت", "کتێبخانە", "سینەما", "پارک", "بەندیخانە", "ڕێستۆرانت", "هۆتێل", "دەریا", "دارستان", "شار", "گوند", "مۆزەخانە", "یاریگا", "قاوەخانە", "شاری یاری", "هۆڵی وەرزش", "زانکۆ", "بانک", "وێستگەی شەمەندەفەر", "شەقام", "ئەشکەوت", "بیابان", "کەنار دەریا", "باخچەی ئاژەڵان", "نانەواخانە", "سەرتاشخانە", "مەزرا", "کۆشک", "پرد", "تونێل", "بنزینخانە", "بنکەی پۆلیس", "بنکەی ئاگرکوژێنەوە", "مەلەوانگە", "چێشتخانە", "هۆڵی ئاهەنگ", "گۆڕەپان", "شاژەن", "کارگە", "تاقیگە", "خەستەخانە", "بەشە ناوخۆیی", "مۆڵ", "سوپەرمارکێت", "باخچەی ساوایان", "هەولێر", "سلێمانی", "دهۆک", "قەڵا", "سەیرانگا", "چیا"] 
    },
    "objects": { 
        label: "کەرەستە", 
        icon: "fa-cube", 
        words: ["مۆبایل", "لاپتۆپ", "کورسی", "قەڵەم", "ئاوێنە", "سەعات", "کتێب", "چەقۆ", "پەرداخ", "تەلەفزیۆن", "کامێرا", "کلیل", "چەکوش", "چرای سەرمێز", "پاتری", "سابون", "خاولی", "شەوت", "دەرمان", "پاکەت", "فڵچەی ددان", "شامپۆ", "سەرین", "بەتانی", "شانە", "مەقەست", "لکێنەر", "جزدان", "پێڵاو", "گۆرەوی", "کڵاو", "چەتر", "گوڵ", "ئەڵقە", "عەینەک", "گوێچکەگر", "مایکرۆفۆن", "گیتار", "پیانۆ", "تۆپ", "مێز", "دەرگا", "پەنجەرە", "سەیارە", "پاسکیل", "کوپ", "قاپ", "کەوچک", "چەتال", "جلشۆر", "فرن", "سەلاجە", "خەڵوز", "گوڵدان", "تەپڵەک", "کۆمپیوتەر", "تابلێت", "پێنوسی جاف", "رۆژمێر", "نەخشە", "ئاڵا"] 
    },
    "food": { 
        label: "خواردن", 
        icon: "fa-hamburger", 
        words: ["پیتزا", "کەباب", "مەنسەف", "یاپراخ", "برنج", "سێو", "هەنار", "قاوە", "شەربەت", "نان", "پەنیر", "ماست", "کێکی لەدایکبوون", "بەستەنی", "شوکۆلاتە", "ماکارۆنی", "شوتی", "سپێناخ", "ترێ", "هەمبەرگر", "پەتاتە", "شۆربا", "زەڵاتە", "گۆشت", "ماسی", "سوشی", "جپس", "چای", "شیر", "ئاو", "هێلکە", "هەنگوین", "مرەبا", "قەیسی", "فراولە", "مۆز", "لیمۆ", "خەیار", "تەماتە", "بیبەر", "کوولەکە", "دۆڵمە", "بریانی", "شفتە", "کفتە", "نیسک", "لۆبیا", "فاسۆلیا", "سەروپێ", "پاقلە", "شێلم", "چەرەزات", "کەرە", "هەنجیر", "کاڵەک", "قۆخ", "خوێ", "شەکر", "زەیتوون", "خورما", "کولێرە"] 
    },
    "animals": { 
        label: "گیانلەبەر", 
        icon: "fa-cat", 
        words: ["شێر", "پشیلە", "سەگ", "گورگ", "هەڵۆ", "کۆتر", "مار", "بزن", "مانگا", "ماسی", "توتی", "مێروولە", "پەپوولە", "بەراز", "کەرکەدەن", "فیل", "مامز", "کیسەڵ", "زەڕافە", "مەیمون", "کەنگەر", "پاندە", "ورچ", "پڵنگ", "کەروێشک", "مشک", "مریشک", "قاز", "ئەسپ", "کەر", "حوشتر", "بوق", "قرژاڵ", "پەنگوین", "دۆلفین", "نەهەنگ", "کووندەپەپوو", "رێوی", "سمۆرە", "داڵ", "مەل", "کەڵەشێر", "قەل", "زەنگەسوورە", "مێش", "هەنگ", "پشک", "مارمێلکە", "قرش", "ئەسپۆکە", "کرم", "تەیر", "باڵندە", "فلامینگۆ", "نەورس"] 
    },
    "jobs": { 
        label: "پیشەکان", 
        icon: "fa-briefcase", 
        words: ["پزیشک", "ئەندازیار", "مامۆستا", "فڕۆکەوان", "پۆلیس", "تەباخ", "نیگارکێش", "وەرزشەوان", "نووسەر", "گۆرانیبێژ", "ئارایشگەر", "شۆفێر", "پارێزەر", "وەستا", "جوتیار", "ئەکتەر", "سەرباز", "ئاگرکوژێنەوە", "پەرستار", "دکتۆری ددان", "فیتەر", "کارەباچی", "شوان", "ماسیگر", "پۆستەچی", "وێنەگر", "خەیات", "دارتاش", "کەشتیوان", "دادوەر", "ڕۆژنامەنووس", "دەرمانساز", "ژمێریار", "وەرگێڕ", "بەڕێوبەر", "کرێکار", "ناوەڕاست", "گۆڵچی", "سەرۆک", "وەزیر", "پەرلەمانتار", "شاعیر", "مۆسیقاژەن", "تەلارساز", "کاسب", "دوکاندار", "فیتەر"] 
    },
    "custom": { label: "تایبەت", icon: "fa-pen-fancy", words: [] }
};

// --- STATE MANAGEMENT ---
let state = {
    players: [], // Just names
    playerStatus: {}, // { name: 'online' | 'offline' }
    numSpies: 1, gameTime: 5, maxGuesses: 1, guessesLeft: 1, manualGuessSet: false,
    selectedCats: new Set([]), isSoundOn: true,
    isHapticsOn: true,
    currentWord: '', assignments: [], activeSpies: 0, activeCitizens: 0, cardIndex: 0, timerRunning: false, timeLeft: 0, timerInt: null,
    // ONLINE VARS
    isOnline: false,
    isHost: false,
    myName: "",
    myRole: null, 
    flippedCount: 0, 
    onlineVotes: {}, 
    mySelectedSuspect: null, 
    isRoomLocked: false,
    gamePhase: 'LOBBY'
};

// --- DOM HELPERS ---
const $ = (id) => document.getElementById(id);
const transitionTo = (viewId) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    $(viewId).classList.add('active');
    playSfx('swish');
};

// --- TOAST NOTIFICATIONS ---
function showToast(message) {
    const container = $('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-box';
    const icon = document.createElement('i');
    icon.className = 'fas fa-exclamation-circle toast-icon';
    const text = document.createElement('span');
    text.innerText = message;
    toast.appendChild(icon);
    toast.appendChild(text);
    container.appendChild(toast);
    playSfx('pop'); 
    triggerVibrate(200);
    setTimeout(() => {
        toast.classList.add('hiding');
        toast.addEventListener('animationend', () => toast.remove());
    }, 3000);
}

// --- MODE SELECTION ---
function startLocalMode() {
    state.isOnline = false;
    state.isHost = true;
    
    $('btn-exit').style.display = 'grid';
    $('btn-back-lobby').style.display = 'none';
    $('player-input-section').style.display = 'block';

    transitionTo('view-setup');
}

// FIX: Host exit delay to ensure close message sends
function exitToMainMenu() {
    if(state.isOnline && state.isHost) {
        broadcast({ type: 'ROOM_CLOSED' });
        // Wait 1 second before destroying to ensure message flies out
        setTimeout(() => {
            performExitCleanup();
        }, 1000);
    } else {
        performExitCleanup();
    }
}

function performExitCleanup() {
    if(peer) { 
        peer.destroy(); 
        peer = null; 
    }
    hostConnections = [];
    myConn = null;

    state.players = [];
    state.playerStatus = {};
    state.isOnline = false;
    state.gamePhase = 'LOBBY';
    state.isRoomLocked = false;
    
    $('player-input').value = '';
    $('my-name-input').value = '';
    $('room-code-input').value = '';
    
    clearSession(); 
    renderTags();
    transitionTo('view-mode');
}

// --- ONLINE LOGIC ---
let peer = null;
let myConn = null; 
let hostConnections = []; 
let reconnectInterval = null; 

function createOnlineRoom(isRestore = false) {
    const name = $('my-name-input').value.trim();
    let customCode = $('room-code-input').value.trim();
    
    if(!name) return showToast("تکایە ناوەکەت بنووسە");
    
    if(!customCode) {
        customCode = Math.floor(1000 + Math.random() * 9000).toString();
        $('room-code-input').value = customCode; 
    }
    
    state.myName = name;
    state.isOnline = true;
    state.isHost = true;
    
    if(!isRestore) {
        state.players = [name];
        state.playerStatus = { [name]: 'online' };
    }
    
    saveSession(true, name, customCode);
    if(peer) peer.destroy();

    // Initialize Peer with specific ID to allow restore
    peer = new Peer("spygame-" + customCode);
    
    peer.on('open', (id) => {
        console.log('Host ID: ' + id);
        $('display-room-code').innerText = customCode;
        
        // Host is always online
        state.playerStatus[state.myName] = 'online';

        if(isRestore) {
            restoreHostGameState();
            // Mark everyone else offline until they reconnect
            state.players.forEach(p => {
                if(p !== state.myName) state.playerStatus[p] = 'offline';
            });
            renderLobbyPlayers(); 
        } else {
            transitionTo('view-lobby-waiting');
        }

        renderLobbyPlayers();
        $('host-controls').style.display = 'flex';
        $('client-wait-msg').style.display = 'none';
        
        updateLockBtnUI();
        if(isRestore) showToast("گەڕایتەوە بۆ ژوورەکەت");
    });

    peer.on('error', (err) => {
        if(err.type === 'unavailable-id') {
            if(isRestore) {
                 // Retry if refreshing quickly
                 console.log("ID Unavailable, retrying...");
                 setTimeout(() => createOnlineRoom(true), 1500); 
            } else {
                 showToast("ئەم کۆدە بەکارهاتووە");
                 clearSession(); 
            }
        } else {
            console.error(err);
            showToast("هەڵەی پەیوەندی");
        }
    });

    peer.on('connection', (conn) => {
        hostConnections.push(conn);
        conn.on('data', (data) => handleHostData(data, conn));
        conn.on('close', () => {
            hostConnections = hostConnections.filter(c => c !== conn);
            if(conn.playerName) {
                state.playerStatus[conn.playerName] = 'offline';
                broadcast({ type: 'UPDATE_LOBBY', players: state.players, statuses: state.playerStatus });
                renderLobbyPlayers();
            }
        });
    });
}

function toggleRoomLock() {
    state.isRoomLocked = !state.isRoomLocked;
    updateLockBtnUI();
    showToast(state.isRoomLocked ? "ژوورەکە داخرا" : "ژوورەکە کرایەوە");
    saveHostGameState();
}

function updateLockBtnUI() {
    const btn = $('btn-lock-room');
    if(state.isRoomLocked) {
        btn.className = "primary-btn success";
        btn.innerHTML = `<span>کردنەوەی ژوور</span> <i class="fas fa-lock-open"></i>`;
    } else {
        btn.className = "primary-btn danger";
        btn.innerHTML = `<span>داخستنی ژوور</span> <i class="fas fa-lock"></i>`;
    }
}

function joinOnlineRoom(isRestore = false) {
    const name = $('my-name-input').value.trim();
    const code = $('room-code-input').value.trim();
    if(!name || !code) return showToast("ناو و کۆد بنووسە");

    saveSession(false, name, code);
    state.myName = name;
    state.isOnline = true;
    state.isHost = false;

    if(peer) peer.destroy();

    peer = new Peer(); 
    peer.on('open', (id) => {
        connectToHost(code, name, isRestore);
    });

    peer.on('error', (err) => {
        clearSession(); 
        showToast("کۆدەکە هەڵەیە یان سێرڤەر نەماوە");
        exitToMainMenu();
    });
}

function connectToHost(code, name, isRestore) {
    if(reconnectInterval) clearInterval(reconnectInterval);

    const conn = peer.connect("spygame-" + code);
    
    conn.on('open', () => {
        console.log("Connected to Host");
        myConn = conn;
        if(reconnectInterval) { clearInterval(reconnectInterval); reconnectInterval = null; }

        conn.send({ type: 'JOIN', name: name, isRejoining: isRestore });
        
        if(!document.querySelector('.view.active').id.includes('view-cards') && 
           !document.querySelector('.view.active').id.includes('view-timer') &&
           !document.querySelector('.view.active').id.includes('view-results')) {
            transitionTo('view-lobby-waiting');
        }
        
        $('display-room-code').innerText = code;
        $('host-controls').style.display = 'none';
        $('client-wait-msg').style.display = 'block';
        $('client-wait-msg').innerText = "چاوەڕێی سێرڤەر بە یاریەکە دەستپێبکات...";
        
        if(isRestore) showToast("گەڕایتەوە ناو یاری");
    });
    
    conn.on('data', (data) => handleClientData(data));
    
    conn.on('close', () => {
        console.log("Disconnected from Host. Attempting reconnect...");
        myConn = null;
        $('client-wait-msg').innerText = "پەیوەندی لەگەڵ سێرڤەر پچڕا. پەیوەندی دەبەستێتەوە...";
        showToast("پەیوەندی پچڕا! هەوڵدەدات پەیوەست بێتەوە...");
        
        // Auto Reconnect Logic
        if(!reconnectInterval) {
            reconnectInterval = setInterval(() => {
                console.log("Reconnecting...");
                connectToHost(code, name, true);
            }, 2000);
        }
    });
}

// --- HOST DATA HANDLER ---
function handleHostData(data, conn) {
    if(data.type === 'JOIN') {
        
        let finalName = data.name;
        let counter = 1;
        
        // Name Duplicate Check
        if (!data.isRejoining || (data.isRejoining && !state.players.includes(data.name))) {
            while(state.players.includes(finalName)) {
                 finalName = `${data.name}_${counter}`;
                 counter++;
            }
        }

        // Notify client if name changed
        if(finalName !== data.name) {
            conn.send({ type: 'NAME_CHANGED', newName: finalName });
        }

        conn.playerName = finalName;
        state.playerStatus[finalName] = 'online'; 

        const isKnown = state.players.includes(finalName);
        
        if (state.isRoomLocked && !isKnown) {
                conn.send({ type: 'ROOM_LOCKED_ERROR' });
                setTimeout(() => conn.close(), 500);
                return;
        }

        if (!isKnown) {
                state.players.push(finalName);
        }
        
        saveHostGameState(); 

        broadcast({ type: 'UPDATE_LOBBY', players: state.players, statuses: state.playerStatus });

        // Restore Game State
        if (state.gamePhase !== 'LOBBY' && state.gamePhase !== 'SETUP') {
            const playerObj = state.assignments.find(a => a.name === finalName);
            if(playerObj) {
                conn.send({
                    type: 'RESTORE_GAME',
                    phase: state.gamePhase,
                    roleObj: playerObj,
                    word: state.currentWord,
                    time: state.gameTime,
                    spiesCount: state.numSpies,
                    guesses: state.maxGuesses,
                    timeLeft: state.timeLeft,
                    players: state.players,
                    statuses: state.playerStatus, 
                    assignments: state.assignments, 
                    votes: state.onlineVotes
                });
            } else {
                conn.send({ type: 'GAME_IN_PROGRESS' }); 
            }
        }
    }
    else if(data.type === 'FLIPPED_BACK') {
        state.flippedCount++;
        if(state.flippedCount >= state.players.length) {
            determineStarter(); 
            const starter = $('starter-name-display').innerText;
            broadcast({ type: 'SHOW_STARTER', starterName: starter });
        }
    }
    else if(data.type === 'SUBMIT_VOTE') {
        if(!state.onlineVotes) state.onlineVotes = {};
        state.onlineVotes[data.voter] = data.suspect;
        saveHostGameState(); 
        
        const voteCount = Object.keys(state.onlineVotes).length;
        const totalPlayers = state.players.length;
        broadcast({ type: 'VOTE_PROGRESS', count: voteCount, total: totalPlayers });
        if(voteCount >= totalPlayers) {
            processVotingResult();
        }
    }
}

// --- CLIENT DATA HANDLER ---
function handleClientData(data) {
    if(data.type === 'NAME_CHANGED') {
        state.myName = data.newName;
        $('my-name-input').value = data.newName; 
        saveSession(false, state.myName, $('room-code-input').value); 
        showToast("ناوەکەت گۆڕدرا بۆ: " + data.newName + " (ناوی دووبارە)");
    }
    else if(data.type === 'UPDATE_LOBBY') {
        state.players = data.players;
        state.playerStatus = data.statuses || {}; 
        renderLobbyPlayers();
    }
    else if(data.type === 'KICKED') {
        showToast("تۆ لە ژوورەک دەرکرایت");
        clearSession();
        setTimeout(() => performExitCleanup(), 1000);
    }
    else if(data.type === 'ROOM_LOCKED_ERROR') {
        showToast("ژوورەکە داخراوە!");
        clearSession();
        setTimeout(() => performExitCleanup(), 1000);
    }
    else if(data.type === 'SETUP_GAME') {
            // Host is setting up
    }
    else if(data.type === 'START_GAME') {
        loadGameData(data);
        transitionTo('view-cards');
        updateOnlineCardView();
    }
    else if(data.type === 'RESTORE_GAME') {
        if(data.players) state.players = data.players;
        if(data.statuses) state.playerStatus = data.statuses;
        
        loadGameData(data);
        if(data.phase === 'CARDS') {
            transitionTo('view-cards');
            updateOnlineCardView();
        } else if (data.phase === 'TIMER') {
            transitionTo('view-timer');
            $('host-timer-controls').style.display = 'none';
            $('client-timer-msg').style.display = 'block';
            updateTimerDisplay(data.time * 60);
        } else if (data.phase === 'VOTING') {
            initVotingPhase();
            transitionTo('view-results');
            const vCount = Object.keys(data.votes || {}).length;
            $('voting-status').innerText = `دەنگدان... (${vCount} / ${state.players.length})`;
        }
    }
    else if(data.type === 'SHOW_STARTER') {
            $('starter-name-display').innerText = data.starterName;
            $('waiting-others-msg').style.display = 'none';
            transitionTo('view-starter');
            playSfx('victory');
    }
    else if(data.type === 'SYNC_TIMER') {
        state.timeLeft = data.timeLeft;
        state.timerRunning = data.running;
        if(!document.getElementById('view-timer').classList.contains('active')) {
                transitionTo('view-timer');
                $('host-timer-controls').style.display = 'none';
                $('client-timer-msg').style.display = 'block';
        }
        updateTimerDisplay(data.totalTime);
    }
    else if(data.type === 'GAME_OVER') {
            endGame();
    }
    else if(data.type === 'VOTE_PROGRESS') {
        $('voting-status').innerText = `دەنگدان... (${data.count} / ${data.total})`;
    }
    else if(data.type === 'VOTE_RESULT') {
        revealEverything(data.winner, data.assignments);
    }
    else if(data.type === 'RETURN_TO_LOBBY') {
        transitionTo('view-lobby-waiting');
        $('client-wait-msg').style.display = 'block'; 
    }
    else if(data.type === 'ROOM_CLOSED') {
        showToast("سێرڤەرەکە داخرا!");
        clearSession();
        setTimeout(() => performExitCleanup(), 1500);
    }
}

function loadGameData(data) {
    state.myRole = data.roleObj;
    state.gameTime = data.time;
    state.currentWord = data.word; 
    state.numSpies = data.spiesCount;
    state.maxGuesses = data.guesses;
    state.timeLeft = data.timeLeft || (data.time * 60);
    state.assignments = data.assignments || []; 
}

function broadcast(msg) {
    hostConnections.forEach(c => c.send(msg));
}

// --- LOBBY LOGIC ---
function renderLobbyPlayers() {
    const container = $('lobby-players-list');
    container.innerHTML = state.players.map((p, index) => {
        const isOnline = state.playerStatus[p] === 'online';
        const statusClass = isOnline ? 'status-online' : 'status-offline';
        
        let html = `<div class="tag">
            <span class="status-dot ${statusClass}"></span>
            ${p} ${p === state.myName ? '(تۆ)' : ''}`;
        
        if(state.isHost && p !== state.myName) {
            html += `<div class="kick-btn" onclick="kickPlayer(${index})"><i class="fas fa-times"></i></div>`;
        }
        html += `</div>`;
        return html;
    }).join('');
}

function kickPlayer(index) {
    const playerToKick = state.players[index];
    if(!playerToKick) return;
    state.players.splice(index, 1);
    delete state.playerStatus[playerToKick];

    const connIdx = hostConnections.findIndex(c => c.playerName === playerToKick);
    if(connIdx !== -1) {
        hostConnections[connIdx].send({ type: 'KICKED' });
        hostConnections.splice(connIdx, 1);
    }
    renderLobbyPlayers();
    broadcast({ type: 'UPDATE_LOBBY', players: state.players, statuses: state.playerStatus });
    saveHostGameState();
}

function setupOnlineGame() {
    state.gamePhase = 'SETUP';
    saveHostGameState();
    transitionTo('view-setup');
    $('btn-exit').style.display = 'none';
    $('btn-back-lobby').style.display = 'grid';
    $('player-input-section').style.display = 'none';
    renderTags();
    broadcast({ type: 'SETUP_GAME' });
}

function backToLobby() {
    state.gamePhase = 'LOBBY';
    saveHostGameState();
    transitionTo('view-lobby-waiting');
}

function resetGameToLobby() {
    if(state.isOnline) {
        if(state.isHost) {
            broadcast({ type: 'RETURN_TO_LOBBY' });
            state.gamePhase = 'LOBBY';
            saveHostGameState();
            transitionTo('view-lobby-waiting');
            state.flippedCount = 0;
            state.onlineVotes = {};
        }
    } else {
        transitionTo('view-setup');
    }
}

// --- SETUP LOGIC ---
const setupGrid = () => {
    const grid = $('topics-container');
    grid.innerHTML = '';
    for (const [key, cat] of Object.entries(CATEGORIES)) {
        const div = document.createElement('div');
        div.className = `topic-card`;
        div.innerHTML = `<i class="fas ${cat.icon}"></i><div class="topic-name">${cat.label}</div>`;
        div.onclick = () => toggleTopic(key, div);
        grid.appendChild(div);
    }
};
setupGrid();

function toggleTopic(key, el) {
    if (state.selectedCats.has(key)) {
        state.selectedCats.delete(key);
        el.classList.remove('selected');
    } else {
        state.selectedCats.add(key);
        el.classList.add('selected');
    }
    if (key === 'custom') {
        const container = $('custom-words-container');
        container.style.display = state.selectedCats.has('custom') ? 'block' : 'none';
        if(state.selectedCats.has('custom')) setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
    playSfx('click');
}

function addPlayer() {
    const input = $('player-input');
    const name = input.value.trim();
    if(name && !state.players.includes(name)) {
        state.players.push(name);
        renderTags();
        input.value = '';
        playSfx('pop');
    }
}

function renderTags() {
    const c = $('players-container');
    const showX = !state.isOnline; 
    c.innerHTML = state.players.map((p,i) => 
        `<div class="tag">${p} ${showX ? `<i class="fas fa-times" onclick="removePlayer(${i})"></i>` : ''}</div>`
    ).join('');
    const spyLimit = Math.max(1, Math.floor(state.players.length / 2));
    if(parseInt($('spy-count').innerText) > spyLimit) $('spy-count').innerText = spyLimit;
}

function removePlayer(i) {
    state.players.splice(i, 1);
    renderTags();
}

function adjVal(id, amount) {
    if(state.isOnline && !state.isHost) return; 
    const el = $(id);
    let val = parseInt(el.innerText);
    
    if(id === 'spy-count') {
        const max = Math.max(1, Math.floor(state.players.length / 2)) || 1;
        val += amount;
        if(val < 1) val = 1; if(val > max && state.players.length > 2) val = max; 
        state.numSpies = val;
    } else if (id === 'guess-count') {
        state.manualGuessSet = true;
        val += amount;
        if(val < 1) val = 1; if(val > 10) val = 10;
        state.maxGuesses = val;
    } else {
        val += amount;
        if(val < 1) val = 1; if(val > 60) val = 60;
        state.gameTime = val;
    }
    el.innerText = val;
    playSfx('click');
}

// --- GAME START ---
function initGame() {
    if (state.players.length < 3) { showToast("لانی کەم دەبێت ٣ یاریزان هەبن"); return; }
    if (state.selectedCats.size === 0) { showToast("تکایە لانی کەم بابەتێک هەڵبژێرە"); return; }
    if(audioCtx.state === 'suspended') audioCtx.resume();

    state.numSpies = parseInt($('spy-count').innerText);
    state.maxGuesses = parseInt($('guess-count').innerText);

    let pool = [];
    state.selectedCats.forEach(catKey => {
        if(catKey === 'custom') {
            const rawText = $('custom-words-input').value;
            const customWords = rawText.split(/[\n,،]+/).map(w => w.trim()).filter(w => w.length > 0);
            if(customWords.length > 0) pool = pool.concat(customWords);
        } else if(CATEGORIES[catKey]) {
            pool = pool.concat(CATEGORIES[catKey].words);
        }
    });

    if(pool.length === 0) { showToast("هەڵەیەک ڕوویدا"); return; }
    state.currentWord = pool[Math.floor(Math.random() * pool.length)];

    // Assign Roles
    let roles = Array(state.numSpies).fill('spy').concat(Array(state.players.length - state.numSpies).fill('citizen'));
    roles.sort(() => Math.random() - 0.5);
    let shuffledPlayers = [...state.players].sort(() => Math.random() - 0.5);

    state.assignments = shuffledPlayers.map((p, i) => ({ name: p, role: roles[i], id: i }));
    state.gamePhase = 'CARDS';

    // Reset any leftover card state from previous games
    isFlipped = false;
    isAnimating = false;
    $('the-card').style.pointerEvents = 'all';

    if (state.isOnline) {
        state.flippedCount = 0;
        state.onlineVotes = {};
        const hostObj = state.assignments.find(a => a.name === state.myName);
        state.myRole = hostObj;
        
        hostConnections.forEach(conn => {
            const playerObj = state.assignments.find(a => a.name === conn.playerName);
            if(playerObj) {
                conn.send({
                    type: 'START_GAME',
                    roleObj: playerObj,
                    time: state.gameTime,
                    word: state.currentWord,
                    spiesCount: state.numSpies,
                    guesses: state.maxGuesses
                });
            }
        });

        saveHostGameState(); 
        $('current-player-name').innerText = state.myName;
        $('card-instruction').innerText = "کارتەکەت ببینە";
        transitionTo('view-cards');
        updateOnlineCardView();

    } else {
        state.cardIndex = 0;
        showCardScreen();
    }
}

// --- CARD LOGIC ---
let isFlipped = false;
let isAnimating = false; 

function showCardScreen() { transitionTo('view-cards'); updateCardView(); }

function updateCardView() { 
    const card = $('the-card');
    card.classList.remove('flipped');
    
    // FIX: Ensure card is clickable for new game
    card.style.pointerEvents = 'all';
    isFlipped = false;
    isAnimating = false;

    setTimeout(() => {
        const player = state.assignments[state.cardIndex];
        $('current-player-name').innerText = player.name;
        applyRoleToCard(player.role === 'spy');
    }, 200);
}

function updateOnlineCardView() { 
    const card = $('the-card');
    card.classList.remove('flipped');
    
    // FIX: Ensure card is clickable for new game
    card.style.pointerEvents = 'all';
    isFlipped = false;
    isAnimating = false;

    applyRoleToCard(state.myRole.role === 'spy');
}

function applyRoleToCard(isSpy) {
    if (isSpy) {
        $('card-back').className = `card-face face-back spy-mode`;
        $('card-role').innerText = "نـهێـنـی";
        $('card-word').innerText = "تۆ سیخوڕیت!";
        $('card-desc').innerText = "خۆت وەکو هاوڵاتی دەربخە. هەوڵبدە لە قسەی ئەوانی ترەوە وشەکە بزانیت.";
    } else {
        $('card-back').className = `card-face face-back`;
        $('card-role').innerText = "تۆ هاوڵاتییت";
        $('card-word').innerText = state.currentWord;
        $('card-desc').innerText = "سیخوڕەکە لە ناوتاندایە. وریا بە لە کاتی پرسیارکردن.";
    }
}

function flipCard() {
    if(isAnimating) return; 
    isAnimating = true;

    const card = $('the-card');
    if(!isFlipped) {
        playSfx('flip'); 
        card.classList.add('flipped'); 
        isFlipped = true;
        triggerVibrate(50);
        setTimeout(() => isAnimating = false, 600);
    } else {
        playSfx('flip'); 
        card.classList.remove('flipped'); 
        isFlipped = false;
        
        setTimeout(() => {
            isAnimating = false;
            if (state.isOnline) {
                $('the-card').style.pointerEvents = 'none';
                $('waiting-others-msg').style.display = 'block';
                
                if(state.isHost) {
                    state.flippedCount++; 
                    if(state.flippedCount >= state.players.length) {
                        determineStarter();
                        broadcast({ type: 'SHOW_STARTER', starterName: $('starter-name-display').innerText });
                    }
                } else {
                    myConn.send({ type: 'FLIPPED_BACK' });
                }
            } else {
                setTimeout(() => {
                    state.cardIndex++;
                    if(state.cardIndex >= state.assignments.length) determineStarter();
                    else updateCardView();
                }, 200);
            }
        }, 600);
    }
}

function determineStarter() {
    const pool = state.assignments;
    const randomStarter =  pool[Math.floor(Math.random() * pool.length)];
    $('starter-name-display').innerText = randomStarter.name;
    transitionTo('view-starter');
    playSfx('victory');
}

// --- TIMER ---
function startTimerView() { 
    if(state.isOnline && !state.isHost) {
            $('start-btn').style.display='none'; 
            return;
    }
    state.gamePhase = 'TIMER';
    if(state.isOnline) saveHostGameState();

    transitionTo('view-timer'); 
    startTimer(state.gameTime * 60); 
}

function startTimer(seconds) {
    state.timeLeft = seconds;
    const totalTime = state.gameTime * 60; 
    updateTimerDisplay(totalTime);
    clearInterval(state.timerInt);
    state.timerRunning = true;
    $('pause-icon').className = "fas fa-pause";
    
    if(state.isOnline && !state.isHost) {
        $('host-timer-controls').style.display = 'none';
        $('client-timer-msg').style.display = 'block';
    } else {
        $('host-timer-controls').style.display = 'flex'; 
        $('client-timer-msg').style.display = 'none';
    }

    if(!state.isOnline || state.isHost) {
        state.timerInt = setInterval(() => {
            if(!state.timerRunning) return;
            state.timeLeft--;
            
            if(state.isOnline && state.isHost) {
                broadcast({ type: 'SYNC_TIMER', timeLeft: state.timeLeft, running: true, totalTime: totalTime });
            }
            
            updateTimerDisplay(totalTime);
            if(state.timeLeft <= 0) { clearInterval(state.timerInt); endGame(); }
        }, 1000);
    }
}

function updateTimerDisplay(total) {
    const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
    const s = (state.timeLeft % 60).toString().padStart(2, '0');
    $('timer-val').innerText = `${m}:${s}`;
    const pct = ((total - state.timeLeft) / total) * 100;
    $('timer-ring').style.setProperty('--progress', `${pct}%`);
    if(state.timeLeft <= 10 && state.timeLeft > 0) playSfx('tick');
}

function togglePause() {
    if(state.isOnline && !state.isHost) return;
    state.timerRunning = !state.timerRunning;
    $('pause-icon').className = state.timerRunning ? "fas fa-pause" : "fas fa-play";
    playSfx('click');
    if(state.isOnline) {
        broadcast({ type: 'SYNC_TIMER', timeLeft: state.timeLeft, running: state.timerRunning, totalTime: state.gameTime * 60 });
    }
}

function endGame() {
    clearInterval(state.timerInt);
    try { playSfx('alarm'); triggerVibrate([200, 100, 200, 100, 500]); } catch(e){}
    if(state.isOnline && state.isHost) broadcast({ type: 'GAME_OVER' });
    initVotingPhase();
    transitionTo('view-results');
}

// --- VOTING ---
function initVotingPhase() {
    state.gamePhase = 'VOTING';
    if(state.isHost) saveHostGameState();

    $('phase-voting').style.display = 'flex';
    $('phase-post-reveal').style.display = 'none';
    $('voting-status').className = 'status-box';
    state.mySelectedSuspect = null; 

    if(state.isOnline) {
        $('attempts-display').style.display = 'none'; 
        $('voting-status').innerText = "تکایە هەمووان دەنگ بدەن";
        $('btn-confirm-vote').style.display = 'flex'; 
        $('btn-confirm-vote').disabled = true;
        $('btn-confirm-vote').innerText = "ناردنی دەنگ";
        $('btn-reveal-all').style.display = 'none';
        $('client-reveal-msg').style.display = 'none';
        if(state.isHost) $('btn-force-end').style.display = 'flex';
    } else {
        state.guessesLeft = state.maxGuesses;
        $('attempts-display').style.display = 'flex';
        $('attempts-count').innerText = state.guessesLeft;
        state.activeSpies = state.numSpies;
        state.activeCitizens = state.players.length - state.numSpies;
        $('voting-status').innerText = "تکایە گومانلێکراو هەڵبژێرە";
        $('btn-confirm-vote').style.display = 'none';
        $('btn-force-end').style.display = 'none';
        $('btn-reveal-all').style.display = 'block';
    }

    const grid = $('suspects-grid');
    grid.innerHTML = '';
    
    state.players.forEach(playerName => {
        const btn = document.createElement('div');
        btn.className = 'suspect-card';
        btn.id = `suspect-${playerName}`;
        btn.innerHTML = `<i class="fas fa-user"></i><div>${playerName}</div>`;
        
        if(state.isOnline) {
            btn.onclick = () => selectSuspectOnline(playerName, btn);
        } else {
            const localPlayerObj = state.assignments.find(p => p.name === playerName);
            btn.onclick = () => checkSuspectLocal(localPlayerObj, btn);
        }
        grid.appendChild(btn);
    });
}

function selectSuspectOnline(suspectName, btnElement) {
    document.querySelectorAll('.suspect-card').forEach(el => el.classList.remove('selected-vote'));
    btnElement.classList.add('selected-vote');
    state.mySelectedSuspect = suspectName;
    
    const btn = $('btn-confirm-vote');
    btn.disabled = false;
    btn.classList.add('pulse'); 
    playSfx('click');
}

function confirmVote() {
    if(!state.mySelectedSuspect) return;
    
    $('btn-confirm-vote').innerText = "چاوەڕوانی ئەوانیت...";
    $('btn-confirm-vote').disabled = true;
    document.querySelectorAll('.suspect-card').forEach(el => el.style.pointerEvents = 'none'); 

    const myVoteData = { type: 'SUBMIT_VOTE', suspect: state.mySelectedSuspect, voter: state.myName };
    
    if(state.isHost) {
        if(!state.onlineVotes) state.onlineVotes = {};
        state.onlineVotes[state.myName] = state.mySelectedSuspect;
        saveHostGameState();
        checkVoteCompletion();
    } else {
        myConn.send(myVoteData);
    }
}

function checkVoteCompletion() {
    const voteCount = Object.keys(state.onlineVotes).length;
    const totalPlayers = state.players.length;
    broadcast({ type: 'VOTE_PROGRESS', count: voteCount, total: totalPlayers });
    $('voting-status').innerText = `دەنگدان... (${voteCount} / ${totalPlayers})`;
    if(voteCount >= totalPlayers) setTimeout(processVotingResult, 1000);
}

function hostSkipVoting() {
    if(!state.isOnline || !state.isHost) return;
    const resultData = { type: 'VOTE_RESULT', victim: null, isSpy: false, winner: 'neutral', assignments: state.assignments };
    broadcast(resultData);
    revealEverything('neutral', state.assignments);
}

function processVotingResult() {
    const counts = {};
    Object.values(state.onlineVotes).forEach(suspect => { counts[suspect] = (counts[suspect] || 0) + 1; });
    
    let victim = null; let maxVotes = -1;
    for(const [suspect, count] of Object.entries(counts)) {
        if(count > maxVotes) { maxVotes = count; victim = suspect; }
    }
    
    const victimObj = state.assignments.find(p => p.name === victim);
    let winner = 'spies'; 
    let isSpy = false;

    if(victimObj && victimObj.role === 'spy') {
        isSpy = true;
        winner = 'citizens';
    }
    
    const resultData = { type: 'VOTE_RESULT', victim: victim, isSpy: isSpy, winner: winner, assignments: state.assignments };
    revealEverything(winner, state.assignments); 
    broadcast(resultData); 
}

function checkSuspectLocal(player, btnElement) {
    const statusBox = $('voting-status');
    if(btnElement.classList.contains('caught') || btnElement.classList.contains('eliminated')) return;

    state.guessesLeft--;
    $('attempts-count').innerText = state.guessesLeft;

    if (player.role === 'spy') {
        playSfx('victory'); triggerVibrate(200);
        state.activeSpies--;
        btnElement.classList.add('caught');
        btnElement.innerHTML = `<i class="fas fa-check"></i><div>${player.name}</div>`;
        statusBox.className = 'status-box success';
        statusBox.innerText = `ئافەرین! ${player.name} سیخوڕ بوو!`;
        if (state.activeSpies === 0) setTimeout(() => revealEverything('citizens'), 1000);
    } else {
        playSfx('pop'); triggerVibrate(50);
        state.activeCitizens--;
        btnElement.classList.add('eliminated');
        statusBox.className = 'status-box error';
        statusBox.innerText = `${player.name} بێتاوانە! سیخوڕ نییە.`;
    }

    if (state.guessesLeft <= 0 && state.activeSpies > 0) setTimeout(() => revealEverything('spies'), 1000);
}

function revealEverything(winner, assignmentsList = null) {
    const currentAssignments = assignmentsList || state.assignments;
    const winDisplay = $('winner-display');
    winDisplay.innerHTML = '';
    if (winner === 'citizens') {
        winDisplay.className = "winner-header winner-citizens";
        winDisplay.innerHTML = `<i class="fas fa-trophy"></i><h1>هاوڵاتیان بردیانەوە!</h1>`;
        playSfx('victory');
    } else if (winner === 'spies') {
        winDisplay.className = "winner-header winner-spies";
        winDisplay.innerHTML = `<i class="fas fa-user-secret"></i><h1>سیخوڕەکان بردیانەوە!</h1>`;
        playSfx('alarm');
    } else {
        winDisplay.className = "winner-header";
        winDisplay.innerHTML = `<i class="fas fa-flag-checkered"></i><h1>ئەنجامەکان</h1>`;
    }

    $('result-word').innerText = state.currentWord || "Error";
    const spies = currentAssignments.filter(a => a.role === 'spy');
    $('spies-list').innerHTML = spies.map(s => 
        `<div class="spy-reveal"><span style="font-weight:bold; color:white">${s.name}</span> <i class="fas fa-user-secret"></i></div>`
    ).join('');

    $('phase-voting').style.display = 'none';
    $('phase-post-reveal').style.display = 'flex';
    $('phase-post-reveal').classList.add('active');
}

// --- UTILS ---
function toggleSound() { 
    state.isSoundOn = !state.isSoundOn; 
    $('btn-sound').style.opacity = state.isSoundOn?1:0.5; 
    $('btn-sound').innerHTML=state.isSoundOn?'<i class="fas fa-volume-up"></i>':'<i class="fas fa-volume-mute"></i>'; 
}

function toggleHaptics() {
    state.isHapticsOn = !state.isHapticsOn;
    $('btn-haptics').style.opacity = state.isHapticsOn ? 1 : 0.5;
    $('btn-haptics').innerHTML = state.isHapticsOn ? '<i class="fas fa-mobile-alt"></i>' : '<i class="fas fa-ban"></i>';
    if(state.isHapticsOn) triggerVibrate(50);
}

function toggleHelp() { const m=$('help-modal'); if(m.style.display==='flex'){m.classList.remove('open');setTimeout(()=>m.style.display='none',300)}else{m.style.display='flex';requestAnimationFrame(()=>m.classList.add('open'));} }

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function createNoiseBuffer() {
    const bufferSize = audioCtx.sampleRate * 2; 
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
    return buffer;
}
const noiseBuffer = createNoiseBuffer();
function playTone(freq, type, duration, vol=0.1) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}
function playSfx(type) {
    if(!state.isSoundOn) return;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;
    if(type === 'click') { playTone(800, 'sine', 0.1, 0.05); }
    else if(type === 'pop') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(now + 0.1);
    }
    else if(type === 'swish') {
        const source = audioCtx.createBufferSource();
        source.buffer = noiseBuffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(600, now);
        filter.frequency.linearRampToValueAtTime(100, now + 0.3);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.3);
        source.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
        source.start(); source.stop(now + 0.3);
    }
    else if(type === 'flip') { playTone(300, 'triangle', 0.15, 0.05); }
    else if(type === 'tick') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(now + 0.05);
    }
    else if(type === 'victory') { [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => { setTimeout(() => playTone(f, 'triangle', 0.6, 0.05), i * 80); }); }
    else if(type === 'alarm') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, now); 
        osc.frequency.exponentialRampToValueAtTime(520, now + 0.5);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.15, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(now + 0.6);
    }
}
function triggerVibrate(pattern) { if (state.isHapticsOn && navigator.vibrate) navigator.vibrate(pattern); }

const pC=$('particles'); for(let i=0;i<20;i++){const p=document.createElement('div');p.className='particle';p.style.left=Math.random()*100+'%';p.style.animationDuration=(Math.random()*10+10)+'s';pC.appendChild(p);}

// --- SESSION AND STATE PERSISTENCE ---

function saveSession(isHost, name, code) {
    sessionStorage.setItem('spy_is_host', isHost);
    sessionStorage.setItem('spy_name', name);
    sessionStorage.setItem('spy_room_code', code);
}

// HOST STATE SAVING
function saveHostGameState() {
    if(!state.isHost) return;
    const gameState = {
        players: state.players,
        playerStatus: state.playerStatus, 
        phase: state.gamePhase,
        currentWord: state.currentWord,
        assignments: state.assignments,
        gameTime: state.gameTime,
        numSpies: state.numSpies,
        maxGuesses: state.maxGuesses,
        timeLeft: state.timeLeft,
        isRoomLocked: state.isRoomLocked,
        flippedCount: state.flippedCount,
        onlineVotes: state.onlineVotes
    };
    sessionStorage.setItem('spy_host_state', JSON.stringify(gameState));
}

function restoreHostGameState() {
    const saved = sessionStorage.getItem('spy_host_state');
    if(saved) {
        const d = JSON.parse(saved);
        state.players = d.players || [];
        state.playerStatus = d.playerStatus || {};
        state.gamePhase = d.phase || 'LOBBY';
        state.currentWord = d.currentWord;
        state.assignments = d.assignments || [];
        state.gameTime = d.gameTime;
        state.numSpies = d.numSpies;
        state.maxGuesses = d.maxGuesses;
        state.timeLeft = d.timeLeft;
        state.isRoomLocked = d.isRoomLocked || false;
        state.flippedCount = d.flippedCount || 0;
        state.onlineVotes = d.onlineVotes || {};
        
        // RESTORE UI BASED ON PHASE
        if(state.gamePhase === 'CARDS') {
            $('current-player-name').innerText = state.myName;
            state.myRole = state.assignments.find(a => a.name === state.myName);
            transitionTo('view-cards');
            updateOnlineCardView();
        } else if(state.gamePhase === 'TIMER') {
            transitionTo('view-timer');
            startTimer(state.timeLeft);
        } else if(state.gamePhase === 'VOTING') {
            initVotingPhase();
            transitionTo('view-results');
            checkVoteCompletion();
        } else if(state.gamePhase === 'SETUP') {
            transitionTo('view-setup');
            renderTags();
        }
    }
}

function clearSession() {
    sessionStorage.removeItem('spy_is_host');
    sessionStorage.removeItem('spy_name');
    sessionStorage.removeItem('spy_room_code');
    sessionStorage.removeItem('spy_host_state');
}

function checkRestoreSession() {
    const code = sessionStorage.getItem('spy_room_code');
    const name = sessionStorage.getItem('spy_name');
    const isHost = sessionStorage.getItem('spy_is_host') === 'true';

    if (code && name) {
        $('my-name-input').value = name;
        $('room-code-input').value = code;
        if (isHost) createOnlineRoom(true); 
        else joinOnlineRoom(true);
    }
}

// Add listener for 'Enter' key in player input
$('player-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        addPlayer();
    }
});

window.addEventListener('load', checkRestoreSession);
</script>
</body>
</html>