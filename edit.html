<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spy Master - Ultimate</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg: #0f172a;
            --primary: #6366f1; /* Indigo */
            --primary-dark: #4338ca;
            --accent: #f43f5e; /* Rose */
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --card-front-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --gold: #f59e0b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Vazirmatn', sans-serif; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0; height: 100vh; height: 100dvh;
            background-color: var(--bg);
            overflow: hidden; color: var(--text);
            display: flex; align-items: center; justify-content: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(244, 63, 94, 0.15) 0%, transparent 20%);
        }

        /* --- ANIMATED BACKGROUND --- */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.5; }
        .particle { position: absolute; border-radius: 50%; background: white; opacity: 0.3; animation: float infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100px) scale(1); opacity: 0; } }

        /* --- APP CONTAINER --- */
        .app-wrapper {
            width: 100%; max-width: 480px; height: 100%; max-height: 900px;
            position: relative; z-index: 10;
            display: flex; flex-direction: column;
        }

        /* --- VIEWS CONTROLLER --- */
        .view {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 24px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .view.active { opacity: 1; pointer-events: all; transform: scale(1); z-index: 5; }
        
        .scroll-content { width: 100%; overflow-y: auto; flex: 1; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
        .scroll-content::-webkit-scrollbar { width: 0px; }

        /* --- UI ELEMENTS --- */
        h1 { margin: 0 0 5px 0; font-size: 1.8rem; font-weight: 900; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; color: transparent; }
        h2 { font-size: 1.4rem; margin: 10px 0; color: #fff; }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; font-weight: 400; }
        
        /* --- TOP BAR --- */
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .icon-btn { background: var(--glass); border: 1px solid var(--glass-border); color: #fff; width: 40px; height: 40px; border-radius: 12px; display: grid; place-items: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: var(--primary); }

        /* --- INPUTS & CHIPS --- */
        .input-box { width: 100%; position: relative; margin-bottom: 20px; display: flex; gap: 8px; }
        .main-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 14px; color: white; font-size: 1rem; text-align: right; }
        .main-input:focus { border-color: var(--primary); }
        .add-btn { width: 50px; background: var(--primary); border: none; border-radius: 16px; color: white; font-size: 1.2rem; cursor: pointer; }
        
        /* Names Grid */
        .tags-container { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .tag { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tag i { opacity: 0.5; cursor: pointer; padding: 4px; }
        .tag i:hover { opacity: 1; color: var(--accent); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Topic Selector */
        .section-title { width: 100%; text-align: right; font-size: 0.9rem; color: var(--text-muted); margin: 10px 0; font-weight: 700; }
        .topics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 10px; }
        .topic-card {
            background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 16px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .topic-card i { display: block; font-size: 1.5rem; margin-bottom: 5px; color: var(--text-muted); transition: 0.3s; }
        /* Selected State */
        .topic-card.selected { background: rgba(99, 102, 241, 0.2); border-color: var(--primary); box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.2); }
        .topic-card.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 5px; right: 8px; font-size: 0.8rem; color: var(--primary); }
        .topic-card.selected i { color: var(--primary); transform: scale(1.1); }
        .topic-name { font-size: 0.9rem; font-weight: 500; }

        /* Custom Input Area */
        #custom-words-container { 
            width: 100%; margin-bottom: 20px; display: none; animation: slideDown 0.3s forwards; 
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 16px; border: 1px dashed var(--glass-border);
        }
        #custom-words-input {
            width: 100%; min-height: 80px; background: transparent; color: white; border: none; 
            resize: vertical; font-size: 0.9rem; line-height: 1.5; outline: none;
        }
        #custom-words-input::placeholder { color: rgba(255,255,255,0.3); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Settings */
        .control-row { display: flex; justify-content: space-between; width: 100%; align-items: center; background: var(--glass); padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 10px; }
        .control-label { display: flex; flex-direction: column; text-align: right; }
        .control-label span { font-weight: 700; font-size: 0.95rem; }
        .control-label small { color: var(--text-muted); font-size: 0.75rem; }
        .stepper { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 12px; }
        .step-btn { color: var(--text); background: none; border: none; font-size: 1.1rem; width: 30px; cursor: pointer; }
        .step-val { font-weight: 900; width: 20px; text-align: center; }

        /* MAIN ACTION BUTTON */
        .primary-btn {
            width: 100%; max-width: 400px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 18px; border-radius: 20px;
            font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 10px 30px -5px rgba(99, 102, 241, 0.5);
            cursor: pointer; 
            margin-top: 5px; 
            z-index: 100;
            position: relative; overflow: hidden; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        .primary-btn:active { transform: scale(0.98); box-shadow: 0 5px 15px -5px rgba(99, 102, 241, 0.5); }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        /* --- GAME CARD 3D --- */
        .card-wrapper { perspective: 1500px; width: 100%; max-width: 320px; height: 420px; margin: 20px 0; }
        .game-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; }
        .game-card.flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 24px; border: 2px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); text-align: center;
            background-size: cover; background-position: center;
        }
        
        .face-front { background: var(--card-front-grad); z-index: 2; }
        .fingerprint { font-size: 4rem; color: rgba(255,255,255,0.1); margin-bottom: 20px; animation: pulse 2s infinite; }
        .tap-text { color: rgba(255,255,255,0.6); font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; }
        
        .face-back { transform: rotateY(180deg); background: white; color: #1e293b; padding: 20px; }
        .role-badge { background: #1e293b; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .secret-word { font-size: 2.2rem; font-weight: 900; color: #1e293b; line-height: 1.2; margin: 15px 0; word-break: break-word; }
        
        /* SPY MODE STYLES */
        .face-back.spy-mode { background: #111; color: #fff; border: 3px solid var(--accent); }
        .face-back.spy-mode .role-badge { background: var(--accent); color: #fff; }
        .face-back.spy-mode .secret-word { 
            color: var(--accent); 
            font-size: 3.2rem; /* BIGGER FONT */
            text-shadow: 0 0 20px rgba(244, 63, 94, 0.4);
            margin: 30px 0;
        }

        @keyframes pulse { 0%,100% { transform: scale(1); opacity: 0.2; } 50% { transform: scale(1.1); opacity: 0.5; } }

        /* --- TIMER --- */
        .timer-ring {
            position: relative; width: 200px; height: 200px; border-radius: 50%;
            display: grid; place-items: center; margin: 40px 0;
            background: conic-gradient(var(--primary) var(--progress, 0%), rgba(255,255,255,0.1) 0);
            transition: background 0.1s linear;
        }
        .timer-ring::before { content:''; position: absolute; inset: 10px; border-radius: 50%; background: var(--bg); }
        .time-text { position: relative; font-size: 3.5rem; font-weight: 900; font-variant-numeric: tabular-nums; }
        
        /* --- STARTER INDICATOR MODAL --- */
        .starter-box {
            background: linear-gradient(135deg, #1e293b, #0f172a); padding: 30px; border-radius: 24px; border: 1px solid var(--glass-border);
            text-align: center; margin: auto; box-shadow: 0 30px 80px rgba(0,0,0,0.7); transform: scale(0.9); animation: bounceIn 0.5s forwards;
        }
        .starter-avatar { width: 70px; height: 70px; background: var(--gold); border-radius: 50%; margin: 0 auto 15px; display: grid; place-items: center; font-size: 2rem; color: #000; }
        @keyframes bounceIn { 0% { opacity:0; transform: scale(0.8); } 60% { transform: scale(1.05); } 100% { opacity:1; transform: scale(1); } }

        /* --- HELP MODAL --- */
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 50; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { width: 85%; background: #1e293b; padding: 25px; border-radius: 24px; max-height: 70%; overflow-y: auto; border: 1px solid var(--glass-border); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; color: var(--text-muted); background: transparent; border: none; font-size: 1.5rem; }
        .rule-item { display: flex; gap: 12px; margin-bottom: 15px; align-items: center; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .rule-icon { width: 35px; height: 35px; background: rgba(255,255,255,0.1); border-radius: 8px; display: grid; place-items: center; color: var(--primary); flex-shrink: 0; }

        /* --- RESULTS --- */
        .results-card { background: rgba(255,255,255,0.05); width: 100%; border-radius: 16px; padding: 15px; margin: 20px 0; }
        .spy-reveal { display: flex; align-items: center; justify-content: space-between; background: rgba(244, 63, 94, 0.2); padding: 12px; border-radius: 10px; margin-top: 10px; border: 1px solid rgba(244, 63, 94, 0.5); }
        
        .result-phase-container { width: 100%; display: flex; flex-direction: column; align-items: center; }

        /* --- FOOTER (FIXED) --- */
        .footer {
            width: 100%;
            text-align: center;
            padding: 15px 0 5px 0;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .footer b { color: var(--primary); font-weight: 900; }
    </style>
</head>
<body>

    <!-- Particles BG -->
    <div class="particles" id="particles"></div>

    <!-- App Container -->
    <div class="app-wrapper">

        <!-- VIEW 1: SETUP -->
        <div id="view-setup" class="view active">
            <div class="top-bar">
                <div class="icon-btn" onclick="toggleSound()" id="btn-sound"><i class="fas fa-volume-up"></i></div>
                <div class="icon-btn" onclick="toggleHelp()"><i class="fas fa-question"></i></div>
            </div>

            <div class="scroll-content">
                <h1>یاری سیخوڕەکە</h1>
                <p class="subtitle">کاتی دۆزینەوەی نهێنیەکانە...</p>

                <!-- Topics -->
                <div class="section-title">بابەت هەڵبژێرە (زیاتر لە یەک دانە ئاساییە):</div>
                <div class="topics-grid" id="topics-container">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Custom Input (Hidden by default) -->
                <div id="custom-words-container">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: bold;">وشە تایبەتەکانت بنووسە:</div>
                    <textarea id="custom-words-input" placeholder="نموونە: تۆپی پێ، باڵە، مەلەوانی... &#10;یان بە ENTER جیایان بکەوە"></textarea>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4); text-align: left; margin-top:5px;">بە کۆما یان دێڕ جیایان بکەرەوە</div>
                </div>

                <!-- Inputs -->
                <div class="section-title">لیستی یاریزانان:</div>
                <div class="input-box">
                    <input type="text" id="player-input" class="main-input" placeholder="ناوی یاریزان..." autocomplete="off">
                    <button class="add-btn" onclick="addPlayer()"><i class="fas fa-plus"></i></button>
                </div>
                <div id="players-container" class="tags-container"></div>
                
                <!-- Game Controls -->
                <div class="section-title">ڕێکخستنەکان:</div>
                <div class="control-row">
                    <div class="control-label">
                        <span>ژمارەی سیخوڕ</span>
                        <small>پێشنیارکراو: ١</small>
                    </div>
                    <div class="stepper">
                        <button class="step-btn" onclick="adjVal('spy-count', -1)">-</button>
                        <span class="step-val" id="spy-count">1</span>
                        <button class="step-btn" onclick="adjVal('spy-count', 1)">+</button>
                    </div>
                </div>

                <div class="control-row">
                    <div class="control-label">
                        <span>کات (خولەک)</span>
                        <small>ماوەی گفتوگۆ</small>
                    </div>
                    <div class="stepper">
                        <button class="step-btn" onclick="adjVal('game-time', -1)">-</button>
                        <span class="step-val" id="game-time">5</span>
                        <button class="step-btn" onclick="adjVal('game-time', 1)">+</button>
                    </div>
                </div>
            </div>

            <button class="primary-btn" id="start-btn" onclick="initGame()">
                دەستپێکردن <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="footer">Made by <a href="https://instagram.com/baxnasi7" target="_blank"> <b>Bawan</b> </a></div>
        </div>

        <!-- VIEW 2: CARDS (Role Reveal) -->
        <div id="view-cards" class="view">
            <div class="top-bar">
                <div class="icon-btn" onclick="confirmExit()"><i class="fas fa-times"></i></div>
                <h2 style="margin:0; font-size: 1rem; color:var(--text-muted);">ڕۆڵەکان</h2>
                <div style="width: 40px;"></div>
            </div>

            <div class="scroll-content" style="justify-content: center;">
                <div style="text-align:center; margin-bottom: 20px;">
                    <div id="current-player-name" style="font-size: 1.4rem; font-weight: bold; margin-bottom: 5px;">Yarizan</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">مۆبایلەکە بدە دەست ئەم کەسە</div>
                </div>

                <div class="card-wrapper">
                    <div class="game-card" id="the-card" onclick="flipCard()">
                        <!-- Front -->
                        <div class="card-face face-front">
                            <i class="fas fa-fingerprint fingerprint"></i>
                            <div class="tap-text">کلیـک بـکە</div>
                        </div>
                        <!-- Back -->
                        <div class="card-face face-back" id="card-back">
                            <div class="role-badge" id="card-role">...</div>
                            <div class="secret-word" id="card-word">...</div>
                            <p id="card-desc" style="color:inherit; opacity: 0.7; font-size:0.9rem; margin-top: 10px; padding: 0 10px;">...</p>
                            <div style="position:absolute; bottom:20px; opacity:0.4; font-size: 0.75rem;">دووبارە کلیک بکە بۆ شاردنەوە</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: STARTER INDICATOR (Who goes first) -->
        <div id="view-starter" class="view" style="justify-content: center;">
             <div class="starter-box">
                 <p style="color: var(--text-muted); margin-bottom: 15px;">پسیاری یەکەم دەکات:</p>
                 <div class="starter-avatar"><i class="fas fa-crown"></i></div>
                 <h2 id="starter-name-display" style="font-size: 2rem; color: #fff; margin: 0;">...</h2>
                 <br>
                 <button class="primary-btn" style="padding: 12px 30px;" onclick="startTimerView()">
                    باشە
                 </button>
             </div>
        </div>

        <!-- VIEW 4: TIMER -->
        <div id="view-timer" class="view">
             <div class="top-bar">
                <h2 style="margin:0;">کات ماوە</h2>
             </div>

             <div class="scroll-content" style="justify-content: center;">
                <div class="timer-ring" id="timer-ring">
                    <div class="time-text" id="timer-val">00:00</div>
                </div>
                <p class="subtitle" style="text-align: center;">پرسیار لە یەکتری بکەن بەبێ ئەوەی نهێنییەکە ئاشکرا بکەن!</p>
                <button class="icon-btn" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.1); margin-bottom: 30px;" onclick="togglePause()">
                    <i class="fas fa-pause" id="pause-icon"></i>
                </button>
             </div>

             <button class="primary-btn" style="background: var(--accent);" onclick="endGame()">
                کۆتایی هێنان بە کات <i class="fas fa-gavel"></i>
            </button>
        </div>

        <!-- VIEW 5: RESULTS -->
        <div id="view-results" class="view">
            <div class="scroll-content" style="align-items: stretch; justify-content: center;">
                
                <!-- Phase 1: Pre Reveal (Button) -->
                <div id="phase-pre-reveal" class="result-phase-container">
                    <div style="text-align: center; margin-bottom: 30px; animation: bounceIn 0.5s;">
                        <i class="fas fa-mask" style="font-size: 5rem; color: var(--text-muted); margin-bottom: 20px;"></i>
                        <h2 style="font-size: 1.8rem;">کاتی دەنگدان</h2>
                        <p class="subtitle">سیخوڕەکە بدۆزنەوە پێش ئەوەی ئاشکرای بکەیت</p>
                    </div>
                    <button class="primary-btn" onclick="revealEverything()">
                        سیخوڕەکە کێیە؟ <i class="fas fa-search"></i>
                    </button>
                </div>

                <!-- Phase 2: Post Reveal (Content) -->
                <div id="phase-post-reveal" class="result-phase-container" style="display: none;">
                    <div style="text-align: center; margin-top: 20px;">
                        <i class="fas fa-flag-checkered" style="font-size: 3rem; color: var(--success);"></i>
                        <h1>ئەنجامەکان</h1>
                    </div>

                    <div class="results-card">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">وشەکە ئەمە بوو:</div>
                        <div id="result-word" style="font-size: 1.8rem; font-weight: 900; color: var(--primary); text-align: center; margin-bottom: 20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px;">-</div>

                        <div style="font-size: 0.9rem; color: var(--accent); font-weight: bold;">سیخوڕەکان:</div>
                        <div id="spies-list"></div>
                    </div>

                    <button class="primary-btn" onclick="goToSetup()">
                        یاری نوێ <i class="fas fa-redo"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="toggleHelp()"><i class="fas fa-times"></i></button>
            <h2>چۆنیەتی یاریکردن</h2>
            <br>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-user"></i></div>
                <div>
                    <b>هاوڵاتی</b>
                    <div style="font-size: 0.8rem; color: #aaa;">وشەکەی دەزانێت. دەبێت پرسیار بکات بۆ دۆزینەوەی سیخوڕەکە بێ ئەوەی وشەکە ئاشکرا بکات.</div>
                </div>
            </div>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-user-secret"></i></div>
                <div>
                    <b>سیخوڕ</b>
                    <div style="font-size: 0.8rem; color: #aaa;">وشەکە نازانێت. دەبێت گوێ بگرێت و خۆی وەکو هاوڵاتی دەرخات بۆ ئەوەی وشەکە بزانێت.</div>
                </div>
            </div>
            <div class="rule-item">
                <div class="rule-icon"><i class="fas fa-trophy"></i></div>
                <div>
                    <b>بردنەوە</b>
                    <div style="font-size: 0.8rem; color: #aaa;">هاوڵاتیان دەیبەنەوە ئەگەر سیخوڕەکە بدۆزنەوە. سیخوڕ دەیباتەوە ئەگەر وشەکە بزانێت.</div>
                </div>
            </div>
            <div class="rule-item">
                <a href="https://instagram.com/baxnasi7">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Instagram_logo_2016.svg/120px-Instagram_logo_2016.svg.png" width="30"/>
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: WORD CATEGORIES ---
        const CATEGORIES = {
            "places": { 
                label: "شوێن", 
                icon: "fa-map-marker-alt", 
                words: [
                    "قوتابخانە", "نەخۆشخانە", "فڕۆکەخانە", "بازاڕ", "مزگەوت", "کتێبخانە", "سینەما", "پارک", 
                    "بەندیخانە", "ڕێستۆرانت", "هۆتێل", "دەریا", "دارستان", "شار", "گوند", "مۆزەخانە", "یاریگا", 
                    "قاوەخانە", "شاری یاری", "هۆڵی وەرزش", "زانکۆ", "بانک", "وێستگەی شەمەندەفەر", "شەقام", 
                    "ئەشکەوت", "بیابان", "کەنار دەریا", "باخچەی ئاژەڵان", "نانەواخانە", "سەرتاشخانە", "مەزرا",
                    "کۆشک", "پرد", "تونێل", "بنزینخانە", "بنکەی پۆلیس", "بنکەی ئاگرکوژێنەوە", "مەلەوانگە"
                ] 
            },
            "objects": { 
                label: "کەرەستە", 
                icon: "fa-cube", 
                words: [
                    "مۆبایل", "لاپتۆپ", "کورسی", "قەڵەم", "ئاوێنە", "سەعات", "کتێب", "چەقۆ", "پەرداخ", 
                    "تەلەفزیۆن", "کامێرا", "کلیل", "چەکوش", "چرای سەرمێز", "پاتری", "سابون", "خاولی", 
                    "شەوت", "دەرمان", "پاکەت", "فڵچەی ددان", "شامپۆ", "سەرین", "بەتانی", "شانە", 
                    "مەقەست", "لکێنەر", "جزدان", "پێڵاو", "گۆرەوی", "کڵاو", "چەتر", "گوڵ", "ئەڵقە", 
                    "عەینەک", "گوێچکەگر", "مایکرۆفۆن", "گیتار", "پیانۆ", "تۆپ"
                ] 
            },
            "food": { 
                label: "خواردن", 
                icon: "fa-hamburger", 
                words: [
                    "پیتزا", "کەباب", "مەنسەف", "یاپراخ", "برنج", "سێو", "هەنار", "قاوە", "شەربەت", 
                    "نان", "پەنیر", "ماست", "کێکی لەدایکبوون", "بەستەنی", "شوکۆلاتە", "ماکارۆنی", 
                    "شوتی", "سپێناخ", "ترێ", "هەمبەرگر", "پەتاتە", "شۆربا", "زەڵاتە", "گۆشت", "ماسی", 
                    "سوشی", "جپس", "چای", "شیر", "ئاو", "هێلکە", "هەنگوین", "مرەبا", "قەیسی", "فراولە", 
                    "مۆز", "لیمۆ", "خەیار", "تەماتە", "بیبەر", "کوولەکە"
                ] 
            },
            "animals": { 
                label: "گیانلەبەر", 
                icon: "fa-cat", 
                words: [
                    "شێر", "پشیلە", "سەگ", "گورگ", "هەڵۆ", "کۆتر", "مار", "بزن", "مانگا", "ماسی", 
                    "توتی", "مێروولە", "پەپوولە", "بەراز", "کەرکەدەن", "فیل", "مامز", "کیسەڵ", "زەڕافە", 
                    "مەیمون", "کەنگەر", "پاندە", "ورچ", "پڵنگ", "کەروێشک", "مشک", "مریشک", "قاز", 
                    "ئەسپ", "کەر", "حوشتر", "بوق", "قرژاڵ", "پەنگوین", "دۆلفین", "نەهەنگ", "کووندەپەپوو"
                ] 
            },
            "jobs": { 
                label: "پیشەکان", 
                icon: "fa-briefcase", 
                words: [
                    "پزیشک", "ئەندازیار", "مامۆستا", "فڕۆکەوان", "پۆلیس", "تەباخ", "نیگارکێش", "وەرزشەوان", 
                    "نووسەر", "گۆرانیبێژ", "ئارایشگەر", "شۆفێر", "پارێزەر", "وەستا", "جوتیار", "ئەکتەر", 
                    "سەرباز", "ئاگرکوژێنەوە", "پەرستار", "دکتۆری ددان", "فیتەر", "کارەباچی", "شوان", 
                    "ماسیگر", "پۆستەچی", "وێنەگر", "خەیات", "دارتاش", "کەشتیوان", "دادوەر", "ڕۆژنامەنووس"
                ] 
            },
            "custom": {
                label: "تایبەت",
                icon: "fa-pen-fancy",
                words: [] // Placeholder
            }
        };

        // --- STATE MANAGEMENT ---
        const state = {
            players: [],
            numSpies: 1,
            gameTime: 5, // minutes
            selectedCats: new Set([]), // Multi-select Set
            isSoundOn: true,
            
            // Game Session
            currentWord: '',
            assignments: [],
            cardIndex: 0,
            timerRunning: false,
            timeLeft: 0,
            timerInt: null
        };

        // --- DOM HELPERS ---
        const $ = (id) => document.getElementById(id);
        const transitionTo = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            $(viewId).classList.add('active');
            playSfx('swish');
        };

        // --- SETUP SCREEN LOGIC ---
        
        // Render Categories
        const setupGrid = () => {
            const grid = $('topics-container');
            grid.innerHTML = '';
            for (const [key, cat] of Object.entries(CATEGORIES)) {
                const div = document.createElement('div');
                div.className = `topic-card`;
                div.innerHTML = `<i class="fas ${cat.icon}"></i><div class="topic-name">${cat.label}</div>`;
                div.onclick = () => toggleTopic(key, div);
                grid.appendChild(div);
            }
        };
        setupGrid();

        function toggleTopic(key, el) {
            if (state.selectedCats.has(key)) {
                state.selectedCats.delete(key);
                el.classList.remove('selected');
            } else {
                state.selectedCats.add(key);
                el.classList.add('selected');
            }
            
            // Toggle Custom Input visibility
            if (key === 'custom') {
                const container = $('custom-words-container');
                if (state.selectedCats.has('custom')) {
                    container.style.display = 'block';
                    // Optional: scroll to it
                    setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                } else {
                    container.style.display = 'none';
                }
            }

            playSfx('click');
            if(navigator.vibrate) navigator.vibrate(10);
        }

        // Player Management
        function addPlayer() {
            const input = $('player-input');
            const name = input.value.trim();
            if(name && !state.players.includes(name)) {
                state.players.push(name);
                renderTags();
                input.value = '';
                playSfx('pop');
            } else if(state.players.includes(name)) {
                input.classList.add('error-shake');
                setTimeout(()=>input.classList.remove('error-shake'), 500);
            }
        }
        $('player-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') addPlayer(); });

        function renderTags() {
            const c = $('players-container');
            c.innerHTML = state.players.map((p,i) => 
                `<div class="tag">${p} <i class="fas fa-times" onclick="removePlayer(${i})"></i></div>`
            ).join('');
            
            // Adjust Max Spies based on players
            const spyLimit = Math.max(1, Math.floor(state.players.length / 2));
            if(parseInt($('spy-count').innerText) > spyLimit) $('spy-count').innerText = spyLimit;
        }

        function removePlayer(i) {
            state.players.splice(i, 1);
            renderTags();
            playSfx('click');
        }

        function adjVal(id, amount) {
            const el = $(id);
            let val = parseInt(el.innerText) + amount;
            if(id === 'spy-count') {
                const max = Math.max(1, Math.floor(state.players.length / 2)) || 1;
                if(val < 1) val = 1;
                if(val > max && state.players.length > 2) val = max; // Only limit if enough players
                state.numSpies = val;
            } else {
                if(val < 1) val = 1;
                if(val > 60) val = 60;
                state.gameTime = val;
            }
            el.innerText = val;
            playSfx('click');
        }

        // --- GAME INITIALIZATION ---
        function initGame() {
            if (state.players.length < 3) {
                alert("لانی کەم دەبێت ٣ یاریزان هەبن");
                return;
            }

            if (state.selectedCats.size === 0) {
                alert("تکایە لانی کەم بابەتێک هەڵبژێرە");
                return;
            }
            
            // Ensure audio context is ready on user gesture
            if(audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            state.numSpies = parseInt($('spy-count').innerText);
            
            // 1. Combine Words from Selected Categories
            let pool = [];
            
            state.selectedCats.forEach(catKey => {
                if(catKey === 'custom') {
                    // PARSE CUSTOM WORDS
                    const rawText = $('custom-words-input').value;
                    const customWords = rawText.split(/[\n,،]+/).map(w => w.trim()).filter(w => w.length > 0);
                    if(customWords.length > 0) {
                        pool = pool.concat(customWords);
                    }
                } else if(CATEGORIES[catKey]) {
                    pool = pool.concat(CATEGORIES[catKey].words);
                }
            });

            if(pool.length === 0) {
                 if(state.selectedCats.has('custom')) {
                    alert("تکایە وشەی تایبەت بنووسە یان بابەتێکی تر هەڵبژێرە");
                 } else {
                    alert("هەڵەیەک ڕوویدا لە دۆزینەوەی وشەکان");
                 }
                 return;
            }

            // Pick Word
            state.currentWord = pool[Math.floor(Math.random() * pool.length)];

            // 2. Assign Roles
            let roles = Array(state.numSpies).fill('spy').concat(
                Array(state.players.length - state.numSpies).fill('citizen')
            );
            roles.sort(() => Math.random() - 0.5); // Shuffle roles

            // 3. Shuffle Players (To not know order)
            let shuffledPlayers = [...state.players].sort(() => Math.random() - 0.5);

            state.assignments = shuffledPlayers.map((p, i) => ({
                name: p,
                role: roles[i]
            }));

            // Reset Loop
            state.cardIndex = 0;
            showCardScreen();
        }

        // --- CARD REVEAL LOOP ---
        let isFlipped = false;
        
        function showCardScreen() {
            transitionTo('view-cards');
            updateCardView();
        }

        function updateCardView() {
            const card = $('the-card');
            card.classList.remove('flipped');
            isFlipped = false;
            
            // Wait for flip back animation
            setTimeout(() => {
                const player = state.assignments[state.cardIndex];
                $('current-player-name').innerText = player.name;
                $('current-player-name').style.color = "white";
                
                // Prepare Card Content (Hidden Side)
                const isSpy = player.role === 'spy';
                
                // Toggle CSS class for Spy Mode
                if (isSpy) {
                    $('card-back').className = `card-face face-back spy-mode`;
                    $('card-role').innerText = "نـهێـنـی"; // Top badge says "Secret" instead of Role
                    $('card-word').innerText = "تۆ سیخوڕیت!"; // BIG TEXT REPLACING ????
                    $('card-desc').innerText = "خۆت وەکو هاوڵاتی دەربخە. هەوڵبدە لە قسەی ئەوانی ترەوە وشەکە بزانیت.";
                } else {
                    $('card-back').className = `card-face face-back`;
                    $('card-role').innerText = "تۆ هاوڵاتییت";
                    $('card-word').innerText = state.currentWord;
                    $('card-desc').innerText = "سیخوڕەکە لە ناوتاندایە. وریا بە لە کاتی پرسیارکردن.";
                }

            }, 200);
        }

        function flipCard() {
            const card = $('the-card');
            
            if(!isFlipped) {
                // REVEAL
                playSfx('flip');
                card.classList.add('flipped');
                isFlipped = true;
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
                // HIDE & NEXT
                playSfx('flip');
                card.classList.remove('flipped');
                isFlipped = false;
                
                setTimeout(() => {
                    state.cardIndex++;
                    if(state.cardIndex >= state.assignments.length) {
                        determineStarter(); // Game Loop End, Start Logic
                    } else {
                        updateCardView();
                    }
                }, 600);
            }
        }

        // --- STARTER & TIMER ---
        function determineStarter() {
            // Find all citizens
            const citizens = state.assignments.filter(p => p.role === 'citizen');
            // Fallback if everyone is spy (unlikely but safe)
            const pool = citizens.length > 0 ? citizens : state.assignments;
            const randomStarter = pool[Math.floor(Math.random() * pool.length)];
            
            $('starter-name-display').innerText = randomStarter.name;
            transitionTo('view-starter');
            playSfx('victory');
        }

        function startTimerView() {
            transitionTo('view-timer');
            startTimer(state.gameTime * 60);
        }

        function startTimer(seconds) {
            state.timeLeft = seconds;
            const totalTime = seconds;
            updateTimerDisplay(totalTime);
            clearInterval(state.timerInt);
            
            state.timerRunning = true;
            $('pause-icon').className = "fas fa-pause";
            
            state.timerInt = setInterval(() => {
                if(!state.timerRunning) return;

                state.timeLeft--;
                updateTimerDisplay(totalTime); // Pass total for progress calc

                if(state.timeLeft <= 0) {
                    clearInterval(state.timerInt);
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay(total) {
            const m = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timeLeft % 60).toString().padStart(2, '0');
            $('timer-val').innerText = `${m}:${s}`;

            // Progress Ring
            const pct = ((total - state.timeLeft) / total) * 100;
            $('timer-ring').style.setProperty('--progress', `${pct}%`);

            if(state.timeLeft <= 10) {
                $('timer-ring').style.background = `conic-gradient(#f43f5e ${pct}%, rgba(255,255,255,0.1) 0)`;
                $('timer-val').style.color = "#f43f5e";
                if(state.timeLeft > 0) playSfx('tick'); // Ticking sound end
            }
        }

        function togglePause() {
            state.timerRunning = !state.timerRunning;
            const icon = $('pause-icon');
            if(state.timerRunning) {
                icon.className = "fas fa-pause";
            } else {
                icon.className = "fas fa-play";
            }
            playSfx('click');
        }

        // --- END GAME & RESULTS LOGIC ---
        function endGame() {
            clearInterval(state.timerInt);
            
            // Play initial alarm
            try {
                playSfx('alarm');
                if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            } catch(e) { console.log("Audio/Vibrate Error", e); }
            
            // Show the "Pre-Reveal" phase (Button Only)
            $('phase-pre-reveal').style.display = 'flex';
            $('phase-post-reveal').style.display = 'none';

            transitionTo('view-results');
        }

        function revealEverything() {
            // Play victory/reveal sound
            playSfx('victory');

            // Populate Data
            $('result-word').innerText = state.currentWord || "Error";
            
            const spies = state.assignments.filter(a => a.role === 'spy');
            $('spies-list').innerHTML = spies.map(s => 
                `<div class="spy-reveal"><span style="font-weight:bold; color:white">${s.name}</span> <i class="fas fa-user-secret"></i></div>`
            ).join('');

            // Toggle Views
            $('phase-pre-reveal').style.display = 'none';
            $('phase-post-reveal').style.display = 'flex';
            
            // Add animation class
            $('phase-post-reveal').classList.add('active');
        }

        function goToSetup() {
            state.timerRunning = false;
            clearInterval(state.timerInt);
            transitionTo('view-setup');
        }

        // --- HELPERS ---
        function toggleSound() {
            state.isSoundOn = !state.isSoundOn;
            const btn = $('btn-sound');
            btn.innerHTML = state.isSoundOn ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            if(!state.isSoundOn) btn.style.opacity = "0.5";
            else btn.style.opacity = "1";
        }

        function toggleHelp() {
            const modal = $('help-modal');
            if(modal.style.display === 'flex') {
                modal.classList.remove('open');
                setTimeout(() => modal.style.display = 'none', 300);
            } else {
                modal.style.display = 'flex';
                // slight delay for css transition
                requestAnimationFrame(()=> modal.classList.add('open'));
            }
        }

        function confirmExit() {
            if(confirm("دەتەوێت یاریەکە کۆتایی پێبهێنیت؟")) {
                goToSetup();
            }
        }

        // Create Particle Animation
        const pContainer = document.getElementById('particles');
        for(let i=0; i<20; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.width = (Math.random() * 20 + 10) + 'px';
            p.style.height = p.style.width;
            p.style.animationDuration = (Math.random() * 10 + 10) + 's';
            p.style.animationDelay = (Math.random() * 5) + 's';
            pContainer.appendChild(p);
        }

        // Audio Synth (Web Audio API) - Lightweight beep system
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            try {
                if(!state.isSoundOn) return;
                if(audioCtx.state === 'suspended') audioCtx.resume();

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                const now = audioCtx.currentTime;

                if(type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'pop') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'flip') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(400, now + 0.2);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                } else if (type === 'alarm') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    osc.frequency.setValueAtTime(440, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else if (type === 'victory') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(523.25, now); // C
                    osc.frequency.setValueAtTime(659.25, now+0.1); // E
                    osc.frequency.setValueAtTime(783.99, now+0.2); // G
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                }
            } catch(e) {
                console.warn("Audio Error:", e);
            }
        }

    </script>
</body>
</html>